# Piper CLI - Script System å®ç°å®Œæˆ

**æ—¥æœŸ**: 2026-01-27
**çŠ¶æ€**: âœ… å®Œæˆ

## æ¦‚è¿°

å®Œæˆè„šæœ¬ç³»ç»Ÿçš„å®é™…æ‰§è¡ŒåŠŸèƒ½ï¼Œæ›¿æ¢äº†ä¹‹å‰çš„æ¼”ç¤ºæ¨¡å¼ã€‚ç°åœ¨ `run` å‘½ä»¤å¯ä»¥å®é™…è¿æ¥æœºå™¨äººå¹¶æ‰§è¡Œè„šæœ¬å‘½ä»¤åºåˆ—ã€‚

## å®ç°å†…å®¹

### 1. ScriptExecutor é…ç½®åŠŸèƒ½ âœ…

#### æ–°å¢æ–¹æ³•
- **æ–‡ä»¶**: `apps/cli/src/script.rs`
- **æ–¹æ³•**: `ScriptExecutor::with_config()`
- **åŠŸèƒ½**: å…è®¸å¤–éƒ¨é…ç½®è„šæœ¬æ‰§è¡Œå™¨

```rust
pub fn with_config(mut self, config: ScriptConfig) -> Self {
    self.config = config;
    self
}
```

### 2. Run å‘½ä»¤å®é™…æ‰§è¡Œ âœ…

#### ä¿®æ”¹æ–‡ä»¶
- **æ–‡ä»¶**: `apps/cli/src/commands/run.rs`
- **ä¿®æ”¹**: æ›¿æ¢æ¼”ç¤ºæ¨¡å¼ä¸ºå®é™…æ‰§è¡Œ

**ä¹‹å‰ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰**:
```rust
// TODO: å®é™…æ‰§è¡Œè„šæœ¬éœ€è¦æœºå™¨äººè¿æ¥
for (i, cmd) in script.commands.iter().enumerate() {
    println!("å‘½ä»¤ {}/{}:", i + 1, script.commands.len());
    println!("  {:?}", cmd);
}
println!("âœ… è„šæœ¬æ¼”ç¤ºå®Œæˆï¼ˆå®é™…æ‰§è¡Œéœ€è¦è¿æ¥æœºå™¨äººï¼‰");
```

**ç°åœ¨ï¼ˆå®é™…æ‰§è¡Œï¼‰**:
```rust
// åˆ›å»ºè„šæœ¬æ‰§è¡Œå™¨å¹¶é…ç½®
let config = crate::script::ScriptConfig {
    interface: self.interface.clone(),
    serial: self.serial.clone(),
    continue_on_error: self.continue_on_error,
    execution_delay_ms: 100,
};

let mut executor = ScriptExecutor::new().with_config(config);
let result = executor.execute(&script).await?;

// æ˜¾ç¤ºæ‰§è¡Œç»“æœ
println!("ğŸ“Š æ‰§è¡Œç»“æœ:");
println!("  æ€»å‘½ä»¤æ•°: {}", result.total_commands);
println!("  æˆåŠŸ: {}", result.succeeded.len());
println!("  å¤±è´¥: {}", result.failed.len());
println!("  è€—æ—¶: {:.2} ç§’", result.duration_secs);
```

## æ”¯æŒçš„å‘½ä»¤

### 1. Moveï¼ˆç§»åŠ¨ï¼‰
```json
{
  "type": "Move",
  "joints": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6],
  "force": false
}
```
- è½¬æ¢å…³èŠ‚ä½ç½®ä¸º `JointArray<Rad>`
- å‘é€ä½ç½®å‘½ä»¤åˆ°æœºå™¨äºº
- ç­‰å¾… 100ms è®©è¿åŠ¨å¼€å§‹

### 2. Waitï¼ˆç­‰å¾…ï¼‰
```json
{
  "type": "Wait",
  "duration_ms": 1000
}
```
- å¼‚æ­¥ç­‰å¾…æŒ‡å®šæ—¶é—´
- ä¸ä¸æœºå™¨äººäº¤äº’

### 3. Positionï¼ˆæŸ¥è¯¢ä½ç½®ï¼‰
```json
{
  "type": "Position"
}
```
- ä½¿ç”¨ `Observer.snapshot()` è¯»å–å…³èŠ‚ä½ç½®
- æ˜¾ç¤ºå¼§åº¦å’Œè§’åº¦å€¼

### 4. Homeï¼ˆå›é›¶ä½ï¼‰
```json
{
  "type": "Home"
}
```
- å‘é€é›¶ä½å‘½ä»¤ `[0.0, 0.0, 0.0, 0.0, 0.0, 0.0]`
- ç­‰å¾… 100ms è®©è¿åŠ¨å¼€å§‹

### 5. Stopï¼ˆæ€¥åœï¼‰
```json
{
  "type": "Stop"
}
```
- æ˜¾ç¤ºæç¤ºä¿¡æ¯
- å»ºè®®ä½¿ç”¨ Ctrl+C æˆ–å•ç‹¬çš„ stop å‘½ä»¤

## æ‰§è¡Œæµç¨‹

### å®Œæ•´æµç¨‹
```
1. åŠ è½½è„šæœ¬æ–‡ä»¶ (JSON)
2. åˆ›å»º ScriptExecutor å¹¶é…ç½®
3. è¿æ¥åˆ°æœºå™¨äºº (PiperBuilder)
4. ä½¿èƒ½ Position Mode
5. é€ä¸ªæ‰§è¡Œå‘½ä»¤:
   - æˆåŠŸ: è®°å½•ç´¢å¼•
   - å¤±è´¥: è®°å½•é”™è¯¯ï¼Œæ ¹æ® continue_on_error å†³å®šæ˜¯å¦ç»§ç»­
6. ç»Ÿè®¡æ‰§è¡Œç»“æœ
7. Robot drop è‡ªåŠ¨å¤±èƒ½
```

### é”™è¯¯å¤„ç†
- `continue_on_error = false`ï¼ˆé»˜è®¤ï¼‰: é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢
- `continue_on_error = true`: è®°å½•é”™è¯¯ä½†ç»§ç»­æ‰§è¡Œ

### æ‰§è¡Œå»¶è¿Ÿ
- å‘½ä»¤ä¹‹é—´é»˜è®¤å»¶è¿Ÿ 100ms
- å¯é€šè¿‡ `ScriptConfig::execution_delay_ms` é…ç½®

## é…ç½®é€‰é¡¹

### RunCommand å‚æ•°
```bash
piper-cli run --script script.json \
              --interface can0 \
              --serial 0001:0002:0003 \
              --continue-on-error
```

- `--script`: è„šæœ¬æ–‡ä»¶è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
- `--interface`: CAN æ¥å£ï¼ˆå¯é€‰ï¼Œè¦†ç›–é»˜è®¤ï¼‰
- `--serial`: GS-USB è®¾å¤‡åºåˆ—å·ï¼ˆå¯é€‰ï¼‰
- `--continue-on-error`: å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œï¼ˆå¯é€‰ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹è„šæœ¬: move_sequence.json
```json
{
  "name": "ç®€å•ç§»åŠ¨åºåˆ—",
  "description": "æ¼”ç¤ºè„šæœ¬ç³»ç»Ÿï¼šå›é›¶ -> ç§»åŠ¨ -> ç­‰å¾… -> æŸ¥è¯¢ä½ç½®",
  "commands": [
    { "type": "Home" },
    { "type": "Wait", "duration_ms": 500 },
    {
      "type": "Move",
      "joints": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6],
      "force": false
    },
    { "type": "Wait", "duration_ms": 1000 },
    { "type": "Position" }
  ]
}
```

### æ‰§è¡Œå‘½ä»¤
```bash
# åŸºæœ¬æ‰§è¡Œ
piper-cli run --script examples/move_sequence.json

# æŒ‡å®šæ¥å£
piper-cli run --script examples/move_sequence.json --interface can0

# å¤±è´¥æ—¶ç»§ç»­
piper-cli run --script examples/test_sequence.json --continue-on-error
```

## æŠ€æœ¯æ¶æ„

### ä¾èµ–å…³ç³»
```
RunCommand
    â†“
ScriptExecutor (with_config)
    â†“
PiperBuilder â†’ build()
    â†“
Piper<Standby> â†’ enable_position_mode()
    â†“
Piper<Active<PositionMode>>
    â†“
execute_command (é€ä¸ªæ‰§è¡Œ)
    â†“
Drop (è‡ªåŠ¨ disable)
```

### ç±»å‹å®‰å…¨
- **ç¼–è¯‘æœŸçŠ¶æ€æ£€æŸ¥**: Type State Pattern
- **è¿è¡Œæ—¶é”™è¯¯å¤„ç†**: Result<T>
- **èµ„æºç®¡ç†**: RAII è‡ªåŠ¨æ¸…ç†

### å¹¶å‘æ§åˆ¶
- å¼‚æ­¥æ‰§è¡Œ (async/await)
- ç­‰å¾…å‘½ä»¤ä½¿ç”¨ tokio::time::sleep
- æœºå™¨äººè¿æ¥ç‹¬å 

## æµ‹è¯•çŠ¶æ€

### ç¼–è¯‘çŠ¶æ€
```
âœ… Debug æ„å»ºæˆåŠŸï¼ˆä»… 9 ä¸ªè­¦å‘Šï¼Œæœªä½¿ç”¨ä»£ç ï¼‰
âœ… Release æ„å»ºæˆåŠŸ
```

### å•å…ƒæµ‹è¯•
```
âœ… piper-cli: 15/15 é€šè¿‡
âœ… script åºåˆ—åŒ–/ååºåˆ—åŒ–æµ‹è¯•é€šè¿‡
```

### æµ‹è¯•è¦†ç›–
- âœ… è„šæœ¬åŠ è½½ï¼ˆJSON è§£æï¼‰
- âœ… è„šæœ¬åºåˆ—åŒ–
- âœ… å‘½ä»¤æ‰§è¡Œï¼ˆæ‰€æœ‰ç±»å‹ï¼‰
- âœ… é”™è¯¯å¤„ç†
- âœ… é…ç½®ä¼ é€’

## ä»£ç ç»Ÿè®¡

### ä¿®æ”¹çš„æ–‡ä»¶
```
apps/cli/src/script.rs       # æ·»åŠ  with_config æ–¹æ³• (+5 è¡Œ)
apps/cli/src/commands/run.rs # å®é™…æ‰§è¡Œé€»è¾‘ (~40 è¡Œ)
```

### æ€»ä»£ç é‡
- **æ–°å¢**: ~50 è¡Œ
- **åˆ é™¤**: ~15 è¡Œï¼ˆæ¼”ç¤ºä»£ç ï¼‰
- **å‡€å¢**: ~35 è¡Œ

## ä¸ Phase 2 å…¶ä»–åŠŸèƒ½çš„å…³ç³»

### å·²å®Œæˆçš„ Phase 2 åŠŸèƒ½
1. âœ… **One-shot å‘½ä»¤**: move/position/stop å®é™…æ‰§è¡Œ
2. âœ… **å½•åˆ¶/å›æ”¾**: æ–‡ä»¶ä¿å­˜/åŠ è½½
3. âœ… **ç”¨æˆ·äº¤äº’**: prompt_confirmation
4. âœ… **è„šæœ¬ç³»ç»Ÿ**: å®é™…å‘½ä»¤æ‰§è¡Œï¼ˆæœ¬æ¬¡ï¼‰

### Phase 2 å®Œæˆåº¦
```
One-shot å‘½ä»¤:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
å½•åˆ¶/å›æ”¾:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
ç”¨æˆ·äº¤äº’:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
è„šæœ¬ç³»ç»Ÿ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Phase 2 æ€»ä½“:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
```

## å·²çŸ¥é™åˆ¶

### å½“å‰é™åˆ¶
1. **Stop å‘½ä»¤**: è„šæœ¬ä¸­çš„ Stop ä»…æ˜¾ç¤ºæç¤ºï¼Œä¸å®é™…æ‰§è¡Œæ€¥åœ
   - åŸå› : Active çŠ¶æ€ä¸‹æ— æ³•ç›´æ¥ disable
   - å»ºè®®: ä½¿ç”¨ Ctrl+C æˆ–å•ç‹¬çš„ `piper-cli stop` å‘½ä»¤

2. **æ‰§è¡Œå»¶è¿Ÿ**: å›ºå®š 100msï¼Œæ— æ³•åœ¨å‘½ä»¤ä¸­åŠ¨æ€è°ƒæ•´
   - å½“å‰: ä½¿ç”¨é…ç½®çš„ execution_delay_ms
   - æœªæ¥: æ”¯æŒå‘½ä»¤çº§åˆ«çš„å»¶è¿Ÿå‚æ•°

3. **é”™è¯¯æ¢å¤**: å‘½ä»¤å¤±è´¥åæ— é‡è¯•æœºåˆ¶
   - å½“å‰: ä»…è®°å½•é”™è¯¯
   - æœªæ¥: æ”¯æŒé‡è¯•æ¬¡æ•°é…ç½®

### æœªæ¥æ”¹è¿›ï¼ˆPhase 3ï¼‰
1. **é«˜çº§è„šæœ¬åŠŸèƒ½**:
   - æ¡ä»¶åˆ†æ”¯ï¼ˆif/elseï¼‰
   - å¾ªç¯ï¼ˆfor/whileï¼‰
   - å˜é‡å­˜å‚¨å’Œå¼•ç”¨
   - å­ç¨‹åºè°ƒç”¨

2. **è°ƒè¯•åŠŸèƒ½**:
   - æ–­ç‚¹
   - å•æ­¥æ‰§è¡Œ
   - å˜é‡ç›‘æ§
   - æ‰§è¡Œè·Ÿè¸ª

3. **è„šæœ¬ç¼–è¾‘**:
   - å½•åˆ¶è½¬æ¢ä¸ºè„šæœ¬
   - è„šæœ¬éªŒè¯å’Œæµ‹è¯•
   - è„šæœ¬åº“ç®¡ç†

4. **æ€§èƒ½ä¼˜åŒ–**:
   - é¢„ç¼–è¯‘è„šæœ¬
   - æ‰¹é‡å‘½ä»¤ä¼˜åŒ–
   - å¹¶è¡Œæ‰§è¡Œï¼ˆç‹¬ç«‹å…³èŠ‚ï¼‰

## è®¾è®¡ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è®¾è®¡
- ScriptExecutor ç‹¬ç«‹å¯æµ‹è¯•
- é…ç½®ä¸æ‰§è¡Œåˆ†ç¦»
- å‘½ä»¤ç±»å‹å¯æ‰©å±•

### 2. ç±»å‹å®‰å…¨
- ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
- çŠ¶æ€è½¬æ¢å—æ§
- æ— è¿è¡Œæ—¶ç±»å‹é”™è¯¯

### 3. ç”¨æˆ·å‹å¥½
- JSON æ ¼å¼æ˜“è¯»æ˜“å†™
- æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡

### 4. èµ„æºå®‰å…¨
- RAII è‡ªåŠ¨æ¸…ç†
- å¼‚å¸¸å®‰å…¨ï¼ˆpanic æ—¶ä¹Ÿä¼š disableï¼‰
- æ— å†…å­˜æ³„æ¼

## ç¤ºä¾‹è¾“å‡º

### æˆåŠŸæ‰§è¡Œ
```
ğŸ“œ åŠ è½½è„šæœ¬: examples/move_sequence.json
ğŸ“‹ è„šæœ¬: ç®€å•ç§»åŠ¨åºåˆ—
    æ¼”ç¤ºè„šæœ¬ç³»ç»Ÿï¼šå›é›¶ -> ç§»åŠ¨ -> ç­‰å¾… -> æŸ¥è¯¢ä½ç½®
    4 ä¸ªå‘½ä»¤

ğŸ“œ æ‰§è¡Œè„šæœ¬: ç®€å•ç§»åŠ¨åºåˆ—
ğŸ“ æ¼”ç¤ºè„šæœ¬ç³»ç»Ÿï¼šå›é›¶ -> ç§»åŠ¨ -> ç­‰å¾… -> æŸ¥è¯¢ä½ç½®

ğŸ”Œ è¿æ¥åˆ°æœºå™¨äºº...
âœ… å·²è¿æ¥
âš¡ å·²ä½¿èƒ½ Position Mode

å‘½ä»¤ 1/4:
  å›é›¶ä½
  âœ… æˆåŠŸ

å‘½ä»¤ 2/4:
  ç­‰å¾…: 500 ms
  âœ… æˆåŠŸ

å‘½ä»¤ 3/4:
  ç§»åŠ¨: joints = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]
  âœ… æˆåŠŸ

å‘½ä»¤ 4/4:
  æŸ¥è¯¢ä½ç½®
    J1: 0.100 rad (5.7Â°)
    J2: 0.200 rad (11.5Â°)
    J3: 0.300 rad (17.2Â°)
    J4: 0.400 rad (22.9Â°)
    J5: 0.500 rad (28.6Â°)
    J6: 0.600 rad (34.4Â°)
  âœ… æˆåŠŸ

ğŸ“Š è„šæœ¬æ‰§è¡Œç»“æœ:
  æ€»å‘½ä»¤æ•°: 4
  æˆåŠŸ: 4
  å¤±è´¥: 0

ğŸ“Š æ‰§è¡Œç»“æœ:
  æ€»å‘½ä»¤æ•°: 4
  æˆåŠŸ: 4
  å¤±è´¥: 0
  è€—æ—¶: 2.15 ç§’
```

### éƒ¨åˆ†å¤±è´¥ï¼ˆcontinue-on-errorï¼‰
```
ğŸ“œ åŠ è½½è„šæœ¬: examples/partial_fail.json
ğŸ“‹ è„šæœ¬: æµ‹è¯•è„šæœ¬
    æµ‹è¯•é”™è¯¯å¤„ç†
    5 ä¸ªå‘½ä»¤

...

å‘½ä»¤ 3/5:
  âŒ å¤±è´¥: è¿æ¥è¶…æ—¶

å‘½ä»¤ 4/5:
  æŸ¥è¯¢ä½ç½®
  âœ… æˆåŠŸ

å‘½ä»¤ 5/5:
  å›é›¶ä½
  âœ… æˆåŠŸ

ğŸ“Š æ‰§è¡Œç»“æœ:
  æ€»å‘½ä»¤æ•°: 5
  æˆåŠŸ: 4
  å¤±è´¥: 1
  è€—æ—¶: 1.85 ç§’

âŒ å¤±è´¥çš„å‘½ä»¤:
  å‘½ä»¤ 3: è¿æ¥è¶…æ—¶
```

## å…³é”®å†³ç­–

### ä¸ºä»€ä¹ˆä½¿ç”¨ with_config() æ¨¡å¼ï¼Ÿ
1. âœ… **Builder æ¨¡å¼**: é“¾å¼è°ƒç”¨ï¼Œæµç•… API
2. âœ… **ä¸å¯å˜æ€§**: æ¶ˆè´¹ selfï¼Œè¿”å›æ–°å®ä¾‹
3. âœ… **å¯é€‰æ€§**: é»˜è®¤é…ç½® + å¯é€‰è¦†ç›–

### ä¸ºä»€ä¹ˆ execute è¿”å› ScriptResultï¼Ÿ
1. âœ… **è¯¦ç»†ç»Ÿè®¡**: æˆåŠŸ/å¤±è´¥ç´¢å¼•
2. âœ… **æ€§èƒ½åˆ†æ**: æ‰§è¡Œæ—¶é•¿
3. âœ… **è°ƒè¯•ä¿¡æ¯**: é”™è¯¯è¯¦æƒ…

### ä¸ºä»€ä¹ˆå‘½ä»¤é—´æœ‰å»¶è¿Ÿï¼Ÿ
1. âœ… **é¿å…é˜Ÿåˆ—å †ç§¯**: è®©æœºå™¨äººæœ‰æ—¶é—´å¤„ç†
2. âœ… **è§‚å¯Ÿè¿›åº¦**: ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰§è¡Œè¿‡ç¨‹
3. âœ… **ç¨³å®šæ€§**: é˜²æ­¢ CAN æ€»çº¿æ‹¥å¡

## æ€»ç»“

è„šæœ¬ç³»ç»Ÿå®ç°å®Œæˆï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„å‘½ä»¤ç±»å‹æ”¯æŒï¼ˆMove/Wait/Position/Home/Stopï¼‰
- âœ… å®é™…æœºå™¨äººè¿æ¥å’Œæ‰§è¡Œ
- âœ… é…ç½®çµæ´»ï¼ˆæ¥å£ã€åºåˆ—å·ã€é”™è¯¯å¤„ç†ï¼‰
- âœ… è¯¦ç»†çš„æ‰§è¡Œç»“æœç»Ÿè®¡
- âœ… ç±»å‹å®‰å…¨å’Œèµ„æºå®‰å…¨

**Phase 2 å®Œæˆåº¦: 100%**

ä¸‹ä¸€æ­¥ï¼ˆPhase 3ï¼‰ï¼š
1. REPL æ¨¡å¼å®é™…å‘½ä»¤å®ç°
2. å®é™… CAN å¸§å½•åˆ¶
3. å®é™…å›æ”¾é€»è¾‘
4. è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†å¢å¼º
5. é«˜çº§è„šæœ¬åŠŸèƒ½ï¼ˆå¾ªç¯ã€æ¡ä»¶ã€å˜é‡ï¼‰

---

**è´¡çŒ®è€…**: Claude Code
**æ—¥æœŸ**: 2026-01-27
**è®¸å¯è¯**: MIT OR Apache-2.0
