# `try_recv` ä½¿ç”¨å®¡è®¡æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-25
**å®¡è®¡èŒƒå›´**: piper-sdk-rs å…¨ä»£ç åº“
**ä¸¥é‡æ€§**: ğŸ”´ ä¸¥é‡ - æ•°æ®ä¸¢å¤±é£é™©

---

## æ‰§è¡Œæ‘˜è¦

åœ¨å®¡è®¡ `crossbeam_channel::Receiver::try_recv()` çš„ä½¿ç”¨æ—¶ï¼Œå‘ç°**ä¸¤å¤„ä¸¥é‡é”™è¯¯**ï¼Œå¯¼è‡´å‘½ä»¤å¸§è¢«ä¸å¿…è¦åœ°æ¶ˆè´¹ï¼ˆconsumeï¼‰ä¸”å¤„ç†ä¸å½“ï¼Œå¯èƒ½é€ æˆï¼š

1. **å‘½ä»¤ä¸¢å¤±**ï¼š`try_recv()` æ¶ˆè´¹äº†æ¶ˆæ¯ä½†æœªæ­£ç¡®å¤„ç†
2. **é€»è¾‘ç¢ç‰‡åŒ–**ï¼šåŒä¸€é˜Ÿåˆ—åœ¨ä¸åŒä½ç½®è¢«æ¶ˆè´¹ï¼Œç ´åè®¾è®¡å®Œæ•´æ€§
3. **ç«æ€æ¡ä»¶**ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘è®¿é—®åŒä¸€é˜Ÿåˆ—

---

## `try_recv()` API è¯­ä¹‰åˆ†æ

### å…³é”®äº‹å®

```rust
match receiver.try_recv() {
    Ok(msg) => {
        // âš ï¸ æ¶ˆæ¯å·²è¢«æ¶ˆè´¹ï¼ˆä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼‰
        // å¿…é¡»ç«‹å³å¤„ç†ï¼Œå¦åˆ™æ¶ˆæ¯ä¸¢å¤±ï¼
    },
    Err(TryRecvError::Empty) => {
        // âœ… é˜Ÿåˆ—ä¸ºç©ºï¼Œæœªæ¶ˆè´¹ä»»ä½•æ¶ˆæ¯
    },
    Err(TryRecvError::Disconnected) => {
        // âœ… é€šé“å·²æ–­å¼€ï¼Œæœªæ¶ˆè´¹ä»»ä½•æ¶ˆæ¯
    },
}
```

### å¸¸è§è¯¯è§£

| è¯¯è§£ | æ­£ç¡®ç†è§£ |
|------|---------|
| `try_recv()` åªæ˜¯"æ£€æŸ¥"é˜Ÿåˆ—çŠ¶æ€ | `try_recv()` **ä¼šæ¶ˆè´¹æ¶ˆæ¯** |
| å¯ä»¥ç”¨ `try_recv()` å®ç°"peek" | âŒ æ—  peek æ“ä½œï¼Œ`try_recv()` å¿…ç„¶æ¶ˆè´¹ |
| å¤šå¤„è°ƒç”¨ `try_recv()` æ˜¯å®‰å…¨çš„ | âŒ åªåº”åœ¨ä¸€ä¸ªåœ°æ–¹æ¶ˆè´¹é˜Ÿåˆ— |

---

## é—®é¢˜ 1: æ–­è¿æ£€æµ‹ä»£ç ï¼ˆğŸ”´ æœ€ä¸¥é‡ï¼‰

**ä½ç½®**: `src/driver/pipeline.rs:107-129`

### é”™è¯¯ä»£ç 

```rust
// ============================================================
// å®šæœŸæ–­è¿æ£€æµ‹ï¼šç¡®ä¿æ£€æµ‹åˆ°å‘½ä»¤é€šé“æ–­å¼€ï¼ˆå³ä½¿é€šé“ä»æœªä¸ºç©ºï¼‰
// ============================================================
if last_disconnect_check.elapsed() > disconnect_check_interval {
    // ä½¿ç”¨ try_recv æ£€æµ‹é€šé“çŠ¶æ€
    // æ³¨æ„ï¼šå¦‚æœé€šé“ä¸­æœ‰æ¶ˆæ¯ï¼Œtry_recv ä¼šæ¶ˆè´¹å®ƒï¼Œæˆ‘ä»¬éœ€è¦ç«‹å³å‘é€å‡ºå»
    match cmd_rx.try_recv() {
        Ok(frame) => {
            // æ¶ˆè´¹äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç«‹å³å‘é€å‡ºå»ï¼ˆé¿å…ä¸¢å¤±ï¼‰
            if let Err(e) = can.send(frame) {
                error!("Failed to send frame consumed by disconnect check: {}", e);
            }
        },
        Err(crossbeam_channel::TryRecvError::Disconnected) => {
            info!("Command channel disconnected, exiting IO loop");
            break;
        },
        Err(crossbeam_channel::TryRecvError::Empty) => {
            // é€šé“ä¸ºç©ºä¸”æ­£å¸¸ï¼Œç»§ç»­å¾ªç¯
        },
    }
    last_disconnect_check = std::time::Instant::now();
}
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| **é‡å¤æ¶ˆè´¹** | `drain_tx_queue()` å·²æ¶ˆè´¹é˜Ÿåˆ—ï¼Œè¿™é‡Œå†æ¬¡æ¶ˆè´¹ | é˜Ÿåˆ—è¢«ä¸¤ä¸ªåœ°æ–¹æ¶ˆè´¹ï¼Œç ´åå•ä¸€æ¶ˆè´¹è€…åŸåˆ™ |
| **ç ´åè°ƒåº¦ç­–ç•¥** | `drain_tx_queue` æœ‰æ—¶é—´é¢„ç®—å’Œæµé‡æ§åˆ¶ | æ­¤å¤„ç»•è¿‡æ‰€æœ‰é™åˆ¶ï¼Œç›´æ¥æ’é˜Ÿå‘é€ |
| **é€»è¾‘ç¢ç‰‡åŒ–** | å‘é€é€»è¾‘æ•£å¸ƒåœ¨å¤šä¸ªä½ç½® | ç»´æŠ¤å›°éš¾ï¼Œä¿®æ”¹å‘é€é€»è¾‘éœ€è¦æ”¹å¤šå¤„ |
| **å®Œå…¨å¤šä½™** | `drain_tx_queue` å†…éƒ¨å·²æ£€æµ‹æ–­è¿ | è¿™æ®µä»£ç æ— ä»»ä½•å®é™…ä»·å€¼ |

### æ­£ç¡®åšæ³•

**åˆ é™¤è¿™æ®µä»£ç **ï¼Œä¾èµ– `drain_tx_queue()` å³å¯ï¼š

```rust
// io_loop å¾ªç¯å¼€å§‹
loop {
    // âœ… drain_tx_queue å†…éƒ¨å·²å¤„ç† try_recv å’Œæ–­è¿æ£€æµ‹
    if drain_tx_queue(&mut can, &cmd_rx) {
        info!("Command channel disconnected, exiting IO loop");
        break;
    }

    // ... å…¶ä»–é€»è¾‘ ...

    // âœ… å¾ªç¯å°¾éƒ¨å†æ¬¡è°ƒç”¨ drain_tx_queue
    if drain_tx_queue(&mut can, &cmd_rx) {
        info!("Command channel disconnected, exiting IO loop");
        break;
    }
}
```

---

## é—®é¢˜ 2: è¶…æ—¶åˆ†æ”¯ä¸­çš„æ–­è¿æ£€æŸ¥ï¼ˆğŸ”´ åŸæœ‰é”™è¯¯ï¼‰

**ä½ç½®**: `src/driver/pipeline.rs:198-207`

### é”™è¯¯ä»£ç 

```rust
Err(CanError::Timeout) => {
    // è¶…æ—¶æ˜¯æ­£å¸¸æƒ…å†µï¼Œæ£€æŸ¥å„ä¸ª pending çŠ¶æ€çš„å¹´é¾„
    // ... (è¶…æ—¶å¤„ç†é€»è¾‘) ...

    // æ£€æŸ¥å‘½ä»¤é€šé“æ˜¯å¦æ–­å¼€ï¼ˆåœ¨ continue ä¹‹å‰æ£€æŸ¥ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰
    match cmd_rx.try_recv() {
        Err(crossbeam_channel::TryRecvError::Disconnected) => {
            // é€šé“æ–­å¼€ï¼Œé€€å‡ºå¾ªç¯
            break;
        },
        _ => {
            // é€šé“æ­£å¸¸æˆ–ä¸ºç©ºï¼Œç»§ç»­å¾ªç¯
            // âŒ BUG: å¦‚æœæ”¶åˆ° Ok(msg)ï¼Œæ¶ˆæ¯è¢«ä¸¢å¼ƒï¼
        },
    }
    continue;
},
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| **æ¶ˆæ¯ä¸¢å¤±** | å¦‚æœ `try_recv()` è¿”å› `Ok(msg)`ï¼Œä»£ç ä»€ä¹ˆéƒ½ä¸åš | å‘½ä»¤å¸§è¢«æ°¸ä¹…ä¸¢å¼ƒ |
| **éå¿…è¦æ£€æŸ¥** | å¾ªç¯å›åˆ°å¼€å¤´ä¼šç«‹å³è°ƒç”¨ `drain_tx_queue()` | é‚£é‡Œä¼šæ£€æµ‹æ–­è¿ï¼Œæ— éœ€æ­¤å¤„é‡å¤æ£€æŸ¥ |
| **è¯¯å¯¼æ€§æ³¨é‡Š** | æ³¨é‡Šè¯´"é¿å…æ— é™å¾ªç¯"ï¼Œå®é™…ä¸ä¼šæ— é™å¾ªç¯ | `can.receive()` æœ‰è¶…æ—¶ï¼Œå¿…ç„¶å›åˆ°å¾ªç¯å¼€å¤´ |

### æ­£ç¡®åšæ³•

**åˆ é™¤è¿™æ®µä»£ç **ï¼Œç›´æ¥ `continue`ï¼š

```rust
Err(CanError::Timeout) => {
    // è¶…æ—¶æ˜¯æ­£å¸¸æƒ…å†µï¼Œæ£€æŸ¥å„ä¸ª pending çŠ¶æ€çš„å¹´é¾„

    // ... (è¶…æ—¶å¤„ç†é€»è¾‘) ...

    // âœ… ç›´æ¥ continueï¼Œå›åˆ°å¾ªç¯å¼€å¤´è°ƒç”¨ drain_tx_queue
    continue;
},
```

---

## æ­£ç¡®ä½¿ç”¨ç¤ºä¾‹

### âœ… `drain_tx_queue()` - æ­£ç¡®æ¨¡å¼

```rust
fn drain_tx_queue(can: &mut impl CanAdapter, cmd_rx: &Receiver<PiperFrame>) -> bool {
    const MAX_DRAIN_PER_CYCLE: usize = 32;
    const TIME_BUDGET: Duration = Duration::from_micros(500);

    let start = std::time::Instant::now();

    for _ in 0..MAX_DRAIN_PER_CYCLE {
        if start.elapsed() > TIME_BUDGET {
            break;
        }

        match cmd_rx.try_recv() {
            Ok(cmd_frame) => {
                // âœ… æ­£ç¡®ï¼šç«‹å³å¤„ç†æ¶ˆæ¯
                if let Err(e) = can.send(cmd_frame) {
                    error!("Failed to send control frame: {}", e);
                }
            },
            Err(crossbeam_channel::TryRecvError::Empty) => {
                // âœ… é˜Ÿåˆ—ä¸ºç©ºï¼Œæ­£å¸¸é€€å‡º
                break;
            },
            Err(crossbeam_channel::TryRecvError::Disconnected) => {
                // âœ… æ£€æµ‹åˆ°æ–­è¿ï¼Œè¿”å› true
                return true;
            },
        }
    }

    false
}
```

### âœ… `tx_loop_mailbox()` - æ­£ç¡®æ¨¡å¼ï¼ˆä¼˜å…ˆçº§è°ƒåº¦ï¼‰

```rust
// ä¼˜å…ˆçº§è°ƒåº¦ï¼šä¼˜å…ˆå¤„ç†å®æ—¶å‘½ä»¤
let frame = if let Ok(f) = realtime_rx.try_recv() {
    // âœ… æ”¶åˆ°å®æ—¶å‘½ä»¤ï¼Œä½¿ç”¨å®ƒ
    f
} else if let Ok(f) = reliable_rx.try_recv() {
    // âœ… æ”¶åˆ°å¯é å‘½ä»¤ï¼Œä½¿ç”¨å®ƒ
    f
} else {
    // ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä¸ºç©ºï¼Œä½¿ç”¨ select! ç­‰å¾…
    match crossbeam_channel::select! {
        recv(realtime_rx) -> msg => msg,
        recv(reliable_rx) -> msg => msg,
        default(Duration::from_millis(1)) => continue,
    } {
        Ok(f) => f,
        Err(_) => break,
    }
};

// âœ… ç«‹å³å‘é€å¸§
match tx.send(frame) {
    Ok(_) => { /* ... */ },
    Err(e) => { /* ... */ },
}
```

---

## å®¡è®¡ç»“æœæ±‡æ€»

### å‘ç°çš„é—®é¢˜

| ä½ç½® | é—®é¢˜ | ä¸¥é‡æ€§ | çŠ¶æ€ |
|------|------|--------|------|
| `src/driver/pipeline.rs:107-129` | æ–­è¿æ£€æµ‹é‡å¤æ¶ˆè´¹é˜Ÿåˆ— | ğŸ”´ ä¸¥é‡ | å¾…ä¿®å¤ |
| `src/driver/pipeline.rs:198-207` | è¶…æ—¶åˆ†æ”¯ä¸¢å¼ƒæ¶ˆæ¯ | ğŸ”´ ä¸¥é‡ | å¾…ä¿®å¤ |

### æ­£ç¡®ä½¿ç”¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

| ä½ç½® | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `src/driver/pipeline.rs:967` | `drain_tx_queue()` ä¸»é€»è¾‘ | âœ… æ­£ç¡® |
| `src/driver/pipeline.rs:1264` | `tx_loop()` å¯é å‘½ä»¤å¤„ç† | âœ… æ­£ç¡® |
| `src/driver/pipeline.rs:1326-1329` | `tx_loop_mailbox()` ä¼˜å…ˆçº§è°ƒåº¦ | âœ… æ­£ç¡® |

---

## ä¿®å¤è®¡åˆ’

### ä¿®å¤ 1: åˆ é™¤æ–­è¿æ£€æµ‹ä»£ç 

```diff
 src/driver/pipeline.rs | 23 -----------------------
 1 file changed, 23 deletions(-)

// åˆ é™¤ç¬¬ 94-129 è¡Œï¼š
- // === æ–­è¿æ£€æµ‹ï¼šå®šæœŸæ£€æŸ¥å‘½ä»¤é€šé“çŠ¶æ€ ===
- let disconnect_check_interval = Duration::from_secs(1);
- let mut last_disconnect_check = std::time::Instant::now();
-
// åœ¨å¾ªç¯ä¸­åˆ é™¤ï¼š
- // ============================================================
- // å®šæœŸæ–­è¿æ£€æµ‹ï¼šç¡®ä¿æ£€æµ‹åˆ°å‘½ä»¤é€šé“æ–­å¼€ï¼ˆå³ä½¿é€šé“ä»æœªä¸ºç©ºï¼‰
- // ============================================================
- if last_disconnect_check.elapsed() > disconnect_check_interval {
-     // ... (æ•´ä¸ª if è¯­å¥) ...
- }
```

### ä¿®å¤ 2: åˆ é™¤è¶…æ—¶åˆ†æ”¯ä¸­çš„æ–­è¿æ£€æŸ¥

```diff
 src/driver/pipeline.rs | 11 -----------
 1 file changed, 11 deletions(-)

// åˆ é™¤ç¬¬ 198-207 è¡Œï¼š
- // æ£€æŸ¥å‘½ä»¤é€šé“æ˜¯å¦æ–­å¼€ï¼ˆåœ¨ continue ä¹‹å‰æ£€æŸ¥ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰
- match cmd_rx.try_recv() {
-     Err(crossbeam_channel::TryRecvError::Disconnected) => {
-         // é€šé“æ–­å¼€ï¼Œé€€å‡ºå¾ªç¯
-         break;
-     },
-     _ => {
-         // é€šé“æ­£å¸¸æˆ–ä¸ºç©ºï¼Œç»§ç»­å¾ªç¯
-     },
- }
```

---

## è®¾è®¡åŸåˆ™æ€»ç»“

### 1. å•ä¸€æ¶ˆè´¹è€…åŸåˆ™

ä¸€ä¸ª `Receiver` é˜Ÿåˆ—åº”è¯¥**åªæœ‰ä¸€ä¸ªåœ°æ–¹æ¶ˆè´¹**ï¼Œé¿å…ï¼š

- âŒ å¤šä¸ª `try_recv()` è°ƒç”¨ç‚¹
- âŒ é€»è¾‘ç¢ç‰‡åŒ–
- âŒ ç«æ€æ¡ä»¶

### 2. æ¶ˆè´¹å³å¤„ç†åŸåˆ™

è°ƒç”¨ `try_recv()` åï¼š

- âœ… **å¿…é¡»**ç«‹å³å¤„ç† `Ok(msg)`
- âŒ ä¸èƒ½å¿½ç•¥æ¶ˆæ¯
- âŒ ä¸èƒ½å»¶è¿Ÿå¤„ç†

### 3. é›†ä¸­åŒ–åŸåˆ™

é˜Ÿåˆ—æ¶ˆè´¹é€»è¾‘åº”è¯¥é›†ä¸­åœ¨ï¼š

- âœ… ä¸“é—¨çš„å‡½æ•°ï¼ˆå¦‚ `drain_tx_queue`ï¼‰
- âœ… ä¸“é—¨çš„çº¿ç¨‹ï¼ˆå¦‚ TX çº¿ç¨‹ï¼‰
- âŒ ä¸åº”è¯¥æ•£å¸ƒåœ¨å¤šä¸ªä½ç½®

### 4. æ–­è¿æ£€æµ‹è‡ªç„¶å‘ç”ŸåŸåˆ™

æ–­è¿æ£€æµ‹ä¸éœ€è¦ä¸“é—¨ä»£ç ï¼š

- âœ… `try_recv()` è¿”å› `Disconnected` æ—¶è‡ªç„¶æ£€æµ‹åˆ°
- âœ… æ­£å¸¸çš„æ¶ˆè´¹é€»è¾‘å·²ç»åŒ…å«æ–­è¿æ£€æµ‹
- âŒ ä¸éœ€è¦é¢å¤–çš„"å®šæœŸæ£€æŸ¥"é€»è¾‘

---

## å‚è€ƒèµ„æ–™

- [crossbeam_channel::Receiver::try_recv() æ–‡æ¡£](https://docs.rs/crossbeam-channel/latest/crossbeam_channel/Receiver.t.html#method.try_recv)
- [Rust å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µ](https://rust-lang.github.io/rust-concurrency-patterns/patterns/message-passing.html)
- [æœ¬é¡¹ç›®çš„ Pipeline è®¾è®¡æ–‡æ¡£](../../docs/v0/pipeline_design.md)

---

## å®¡è®¡äººå‘˜

- **å‘ç°**: Claude Sonnet 4.5 (AI Assistant)
- **å®¡æ ¸å»ºè®®**: ç”¨æˆ·ä»£ç å®¡æŸ¥
- **æ—¥æœŸ**: 2026-01-25
