# Piper SDK Workspace é‡æ„æ–‡æ¡£

æœ¬ç›®å½•åŒ…å«å°† piper-sdk-rs é‡æ„ä¸º Cargo workspace çš„å®Œæ•´åˆ†æå’Œè§„åˆ’æ–‡æ¡£ã€‚

## ğŸ“š æ–‡æ¡£ç›®å½•

### 1. [åˆ†ææŠ¥å‘Š](./analysis_report.md) â­ ä»è¿™é‡Œå¼€å§‹
**è¯¦ç»†çš„æŠ€æœ¯åˆ†æå’Œæ”¶ç›Šè¯„ä¼°**

- å½“å‰é¡¹ç›®ç»“æ„åˆ†æï¼ˆ35K+ è¡Œä»£ç ï¼‰
- ä¸ºä»€ä¹ˆéœ€è¦ workspace
- æ‹Ÿè®®çš„ workspace ç»“æ„
- æ‰©å±•é¡¹ç›®è§„åˆ’ï¼ˆä¸Šä½æœºã€CLI å·¥å…·ç­‰ï¼‰
- ä»£ç ç»Ÿè®¡å’Œä¾èµ–åˆ†æ
- é¢„æœŸæ”¶ç›Šï¼ˆç¼–è¯‘æ—¶é—´ -40~-60%ï¼‰

**é€‚åˆ**: éœ€è¦äº†è§£å…¨å±€è§†è§’çš„æŠ€æœ¯å†³ç­–è€…ã€æ¶æ„å¸ˆ

---

### 2. [è¿ç§»è®¡åˆ’](./migration_plan.md) ğŸ› ï¸ å®æ–½æŒ‡å—
**é€æ­¥çš„ã€å¯æ“ä½œçš„è¿ç§»æŒ‡å—**

- 9 ä¸ªè¯¦ç»†é˜¶æ®µï¼ˆæ¯ä¸ª 0.5-1 å¤©ï¼‰
- æ¯ä¸ªé˜¶æ®µçš„ä»£ç ç¤ºä¾‹å’ŒéªŒæ”¶æ ‡å‡†
- å›æ»šè®¡åˆ’å’Œé£é™©ç¼“è§£
- æ—¶é—´ä¼°ç®—ï¼ˆæ€»è®¡ 7-9 å¤©ï¼‰
- å¸¸è§é—®é¢˜è§£ç­”

**é€‚åˆ**: æ‰§è¡Œè¿ç§»çš„å¼€å‘å·¥ç¨‹å¸ˆã€é¡¹ç›®ç»ç†

---

### 3. [æ¶æ„å†³ç­–è®°å½•](./architecture_decision_record.md) ğŸ“‹ å†³ç­–æ–‡æ¡£
**æ ‡å‡†åŒ–çš„é—®é¢˜åˆ†æå’Œå†³ç­–è®°å½•**

- èƒŒæ™¯å’Œé—®é¢˜é™ˆè¿°
- æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”
- æƒè¡¡åˆ†æï¼ˆä¼˜åŠ¿/åŠ£åŠ¿ï¼‰
- æˆåŠŸæŒ‡æ ‡
- å†³ç­–å†å²

**é€‚åˆ**: éœ€è¦ç†è§£"ä¸ºä»€ä¹ˆ"çš„å¹²ç³»äººã€å®¡æŸ¥è€…

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æˆ‘æƒ³äº†è§£å…¨å±€æƒ…å†µ
1. é˜…è¯» [åˆ†ææŠ¥å‘Š](./analysis_report.md) çš„"æ‰§è¡Œæ‘˜è¦"å’Œ"å»ºè®®çš„ Workspace ç»“æ„"
2. æŸ¥çœ‹"é¢„æœŸæ”¶ç›Š"äº†è§£æ”¹å–„æ•°æ®

### æˆ‘æƒ³æ‰§è¡Œè¿ç§»
1. é˜…è¯» [è¿ç§»è®¡åˆ’](./migration_plan.md)
2. ä»"é˜¶æ®µ 0: å‡†å¤‡å·¥ä½œ"å¼€å§‹
3. æŒ‰é¡ºåºå®Œæˆæ‰€æœ‰é˜¶æ®µ

### æˆ‘æƒ³å®¡æŸ¥å†³ç­–
1. é˜…è¯» [æ¶æ„å†³ç­–è®°å½•](./architecture_decision_record.md)
2. æŸ¥çœ‹"æ›¿ä»£æ–¹æ¡ˆ"å’Œ"æƒè¡¡åˆ†æ"

---

## ğŸ“Š å…³é”®æ•°æ®

### å½“å‰é¡¹ç›®è§„æ¨¡
- **ä»£ç è¡Œæ•°**: 35,000+ è¡Œ
- **æ–‡ä»¶æ•°**: 106 ä¸ª Rust æ–‡ä»¶
- **æµ‹è¯•æ•°**: 561 ä¸ªæµ‹è¯•
- **æ¨¡å—æ•°**: 4 å±‚æ¶æ„

### é¢„æœŸæ”¹å–„
| æŒ‡æ ‡ | æ”¹å–„å¹…åº¦ |
|------|----------|
| ç¼–è¯‘æ—¶é—´ï¼ˆä¿®æ”¹å®¢æˆ·ç«¯ï¼‰ | **-60%** |
| ç¼–è¯‘æ—¶é—´ï¼ˆä¿®æ”¹åè®®ï¼‰ | **-50%** |
| ç¼–è¯‘æ—¶é—´ï¼ˆä¿®æ”¹å®ˆæŠ¤è¿›ç¨‹ï¼‰ | **-88%** |
| ä¾èµ–ä½“ç§¯ï¼ˆåµŒå…¥å¼ç”¨æˆ·ï¼‰ | **-87%** |

### å»ºè®®çš„ Crate ç»“æ„
```
piper-protocol    (6.2K LOC)  â† æ— ç¡¬ä»¶ä¾èµ–
    â†“
piper-can         (4.5K LOC)  â† CAN æŠ½è±¡
    â†“
piper-driver      (5.8K LOC)  â† IO ç®¡ç†
    â†“
piper-client      (8.2K LOC)  â† é«˜çº§ API
    â†“
piper-sdk         (èšåˆåº“)    â† å‘åå…¼å®¹
```

---

## ğŸ”® æ‰©å±•é¡¹ç›®è§„åˆ’

### çŸ­æœŸï¼ˆè¿ç§»å®Œæˆåï¼‰
- âœ… `apps/cli` - å‘½ä»¤è¡Œå·¥å…·
- âœ… `tools/can-sniffer` - CAN æ€»çº¿ç›‘æ§

### ä¸­æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰
- âœ… `apps/gui` - ä¸Šä½æœº GUI (Tauri)
- âœ… `tools/protocol-analyzer` - åè®®åˆ†æå™¨

### é•¿æœŸï¼ˆ6-12 ä¸ªæœˆï¼‰
- ğŸ”® `bindings/python` - Python ç»‘å®š
- ğŸ”® `clients/ros2` - ROS 2 èŠ‚ç‚¹
- ğŸ”® `wasm/piper-protocol` - WebAssembly ç‰ˆæœ¬

---

## â“ å¸¸è§é—®é¢˜

### Q: è¿™ä¼šå½±å“ç°æœ‰ç”¨æˆ·å—ï¼Ÿ
**A**: ä¸ä¼šã€‚é€šè¿‡ `piper-sdk` èšåˆåº“ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼š

```rust
// æ—§ä»£ç ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
use piper_sdk::prelude::*;
let piper = PiperBuilder::new().build()?;
```

### Q: è¿ç§»éœ€è¦å¤šä¹…ï¼Ÿ
**A**: é¢„è®¡ 7-9 å¤©ï¼š
- å‡†å¤‡ï¼š1 å¤©
- æ‹†åˆ† cratesï¼š5 å¤©
- æ›´æ–°å¤–éƒ¨ä»£ç ï¼š1 å¤©
- æ–‡æ¡£å’Œå‘å¸ƒï¼š1-2 å¤©

### Q: å¯ä»¥å›æ»šå—ï¼Ÿ
**A**: å¯ä»¥ã€‚åˆ†é˜¶æ®µè¿ç§»ï¼Œæ¯é˜¶æ®µç‹¬ç«‹å¯éªŒè¯ï¼Œéšæ—¶å¯ä»¥å›æ»šã€‚

### Q: ç¼–è¯‘æ—¶é—´çœŸçš„ä¼šæ”¹å–„å—ï¼Ÿ
**A**: æ˜¯çš„ã€‚åŸºäºç±»ä¼¼é¡¹ç›®çš„ç»éªŒï¼š
- åè®®å±‚ä¿®æ”¹ï¼š-50% (42s â†’ 21s)
- å®¢æˆ·ç«¯ä¿®æ”¹ï¼š-60% (42s â†’ 17s)
- å®ˆæŠ¤è¿›ç¨‹ä¿®æ”¹ï¼š-88% (42s â†’ 5s)

---

## ğŸ“ æ–‡æ¡£æ”¹è¿›è®°å½•

åŸºäºä¸“ä¸šä»£ç å®¡æŸ¥åé¦ˆå’Œçº¢é˜Ÿæµ‹è¯•ï¼ˆ2026-01-25ï¼‰ï¼Œæœ¬æ–‡æ¡£å·²è¿›è¡Œä»¥ä¸‹å…³é”®æ”¹è¿›ï¼š

### ğŸš¨ å…³é”®æ”¹è¿›

#### 1. Git å†å²ä¿æŠ¤
- âœ… **æ‰€æœ‰ `mv` å‘½ä»¤æ›¿æ¢ä¸º `git mv`**
- âœ… å¼ºè°ƒåˆ†ç¦»æ–‡ä»¶ç§»åŠ¨å’Œå†…å®¹ä¿®æ”¹çš„é‡è¦æ€§
- âœ… æ·»åŠ äº† `mv` çš„æ¢å¤æ–¹æ³•

#### 2. å¾ªç¯å¼€å‘ä¾èµ–é¢„é˜²
- âœ… æ–°å¢**é˜¶æ®µ 0.5: æ£€æŸ¥å…¬å…±ç±»å‹å’Œæµ‹è¯•å·¥å…·**
- âœ… æ£€æŸ¥ `utils.rs` å’Œ `common.rs`
- âœ… æ£€æŸ¥ `tests/` æ˜¯å¦æœ‰å…±äº«æµ‹è¯•è¾…åŠ©ä»£ç 
- âœ… è¯„ä¼°å¾ªç¯ä¾èµ–é£é™©

#### 3. Virtual Workspace tests/ å¿½ç•¥é—®é¢˜
- âœ… æ–°å¢**é˜¶æ®µ 0.6: æ£€æŸ¥ .gitignore**
- âœ… æ–°å¢**é˜¶æ®µ 1.2: æ¸…ç†æ—§ Cargo.lock**
- âœ… æ–°å¢**é˜¶æ®µ 8.1: ç§»åŠ¨é›†æˆæµ‹è¯•åˆ° piper-sdk crate**
- âœ… è¯¦ç»†è§£é‡Š Virtual Workspace ä¸ºä½•å¿½ç•¥æ ¹ `tests/`
- âœ… æä¾›å®Œæ•´çš„æµ‹è¯•ç§»åŠ¨å’ŒéªŒè¯æµç¨‹
- âš ï¸ **è¿™æ˜¯æœ€éšè”½ä½†æœ€ä¸¥é‡çš„é™·é˜±**

#### 4. âš ï¸ **è¯­æ³•é”™è¯¯ä¿®å¤**ï¼ˆæ·±åº¦ä»£ç å®¡æŸ¥å‘ç°ï¼‰
- âœ… **ä¿®å¤é”™è¯¯A**: ç§»é™¤ `[workspace.dependencies]` ä¸­çš„ `target.'cfg...'` è¯­æ³•
- âœ… **ä¿®å¤é”™è¯¯B**: è°ƒæ•´æ‰€æœ‰ `git mv` å‘½ä»¤ï¼Œé¿å…æ–‡ä»¶å¤¹åµŒå¥—é—®é¢˜
  - é˜¶æ®µ 2.3 (protocol): ç§»åŠ¨åè°ƒæ•´å±‚çº§ï¼Œåˆå¹¶ `mod.rs` åˆ° `lib.rs`
  - é˜¶æ®µ 3.3 (can): ç§»åŠ¨åè°ƒæ•´å±‚çº§ï¼Œåˆå¹¶ `mod.rs` åˆ° `lib.rs`
  - é˜¶æ®µ 4.3 (driver): ç§»åŠ¨åè°ƒæ•´å±‚çº§ï¼Œåˆå¹¶ `mod.rs` åˆ° `lib.rs`
  - é˜¶æ®µ 5.3 (client): ç§»åŠ¨åè°ƒæ•´å±‚çº§ï¼Œåˆå¹¶ `mod.rs` åˆ° `lib.rs`
- âœ… **æ·»åŠ ç»†èŠ‚C**: æ–°å¢**é˜¶æ®µ 0.7: æ£€æŸ¥é Cargo æ„å»ºé…ç½®**ï¼ˆDockerfile, Makefile, CI/CDï¼‰
- âœ… **æ·»åŠ ç»†èŠ‚D**: æ–°å¢**é˜¶æ®µ 9.3.1: é…ç½® cargo-release**ï¼ˆtag å‘½åå’Œç‰ˆæœ¬ç®¡ç†ï¼‰

#### 5. âš ï¸ **é…ç½®é€»è¾‘ä¿®å¤**ï¼ˆçº¢é˜Ÿæµ‹è¯•å‘ç°ï¼‰
- âœ… **ä¿®å¤é—®é¢˜ 1**: Feature Flags çš„ `dep:` è¯­æ³•ä¸ `optional = true` é…åˆ
  - é˜¶æ®µ 3.2: ä¸º `socketcan` å’Œ `rusb` æ·»åŠ  `optional = true`
  - é˜¶æ®µ 9.25.1: ç§»é™¤ `dep:` è¯­æ³•ï¼Œæ”¹ç”¨å¹³å°è‡ªåŠ¨é€‰æ‹©é€»è¾‘
  - è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆä¸ç”¨ `dep:` è¯­æ³•ï¼ˆä¾èµ–å·²é€šè¿‡ `target cfg` åŒ…å«ï¼‰
- âœ… **ä¿®å¤é—®é¢˜ 2**: å‘å¸ƒæµç¨‹å·¥å…·æ··æ·†
  - é˜¶æ®µ 9.3.3: æ˜ç¡®ä¸º"æ‰‹åŠ¨å‘å¸ƒå¤‡é€‰æ–¹æ¡ˆ"ï¼Œä½¿ç”¨ `cargo publish`ï¼ˆåŸç”Ÿå‘½ä»¤ï¼‰
  - é˜¶æ®µ 9.3.4: æ˜ç¡®ä¸º"è‡ªåŠ¨å‘å¸ƒæ¨èæ–¹æ¡ˆ"ï¼Œä½¿ç”¨ `cargo release --workspace`ï¼ˆå·¥å…·å‘½ä»¤ï¼‰
  - æ¶ˆé™¤äº†ä¸ `shared-version = true` é…ç½®çš„å†²çª

#### 6. Feature Flags é…ç½®
- âœ… æ–°å¢**é˜¶æ®µ 9.25: é…ç½® Feature Flags**
- âœ… åœ¨ `piper-can` ä¸­å®šä¹‰å¹³å°ç‰¹å®š featuresï¼ˆä½¿ç”¨ optional = trueï¼‰
- âœ… åœ¨ `piper-sdk` ä¸­é‡æ–°æš´éœ² featuresï¼ˆä¸ä½¿ç”¨ dep: è¯­æ³•ï¼‰
- âœ… éªŒè¯ Feature Flags ä¼ é€’æ­£ç¡®æ€§

#### 7. æ–‡æ¡£å†…é“¾æ¥æ£€æŸ¥
- âœ… æ–°å¢**é˜¶æ®µ 9.26: æ£€æŸ¥æ–‡æ¡£å†…é“¾æ¥**
- âœ… æ£€æµ‹ broken intra-doc links
- âœ… æä¾›ä¿®å¤æ–¹æ³•

#### 8. å‘å¸ƒæµç¨‹ä¼˜åŒ–
- âœ… æ–°å¢**é˜¶æ®µ 9.3.1: cargo-release workspace é…ç½®**
  - ç»Ÿä¸€ tag å‘½åæ ¼å¼ï¼ˆ`v{{version}}`ï¼‰
  - å…±äº«ç‰ˆæœ¬å·ï¼ˆ`shared-version = true`ï¼‰
  - åŸå­æ“ä½œï¼ˆ`consolidate-commits/pushes = true`ï¼‰
- âœ… æ–°å¢**é˜¶æ®µ 9.3.3: æ‰‹åŠ¨å‘å¸ƒå¤‡é€‰æ–¹æ¡ˆ**ï¼ˆä½¿ç”¨ `cargo publish`ï¼‰
- âœ… æ–°å¢**é˜¶æ®µ 9.3.4: è‡ªåŠ¨å‘å¸ƒæ¨èæ–¹æ¡ˆ**ï¼ˆä½¿ç”¨ `cargo release --workspace`ï¼‰
- âœ… **æ–°å¢éªŒè¯æ­¥éª¤**: ç¡®ä¿å†…éƒ¨ä¾èµ–ä½¿ç”¨ `workspace = true` æˆ–åŒ…å« `version`

### ğŸ“Š è¿ç§»é˜¶æ®µè°ƒæ•´

**åŸè®¡åˆ’**: 9 ä¸ªé˜¶æ®µ
**æœ€ç»ˆè®¡åˆ’**: 11 ä¸ªé˜¶æ®µï¼ˆæ–°å¢é˜¶æ®µ 0.5, 0.6, 0.7ï¼‰

| é˜¶æ®µ | çŠ¶æ€ | æ”¹è¿›å†…å®¹ |
|------|------|----------|
| 0.5 | æ–°å¢ | æ£€æŸ¥å…¬å…±ç±»å‹å’Œæµ‹è¯•å·¥å…· |
| 0.6 | æ–°å¢ | æ£€æŸ¥ .gitignore é…ç½® |
| 0.7 | æ–°å¢ | **æ£€æŸ¥é Cargo æ„å»ºé…ç½®**ï¼ˆDockerfile, Makefile, CI/CDï¼‰ |
| 1.1 | ä¿®å¤ | **ç§»é™¤ workspace.dependencies ä¸­çš„ target cfg è¯­æ³•** |
| 1.2 | æ–°å¢ | æ¸…ç†æ—§ Cargo.lock |
| 2.3 | ä¿®å¤ | **git mv é¿å…åµŒå¥— + åˆå¹¶ mod.rs åˆ° lib.rs** |
| 2.4 | æ”¹è¿› | æ–°å¢ mod.rs åˆå¹¶æ­¥éª¤å’Œåˆ é™¤å‘½ä»¤ |
| 3.2 | ä¿®å¤ | **æ·»åŠ  optional = trueï¼Œé…åˆ features ä½¿ç”¨** |
| 3.3 | ä¿®å¤ | **git mv é¿å…åµŒå¥— + åˆå¹¶ mod.rs åˆ° lib.rs** |
| 3.4 | æ”¹è¿› | æ–°å¢ mod.rs åˆå¹¶æ­¥éª¤å’Œå†…éƒ¨å¯¼å…¥æ›´æ–° |
| 4.3 | ä¿®å¤ | **git mv é¿å…åµŒå¥— + åˆå¹¶ mod.rs åˆ° lib.rs** |
| 4.4 | æ”¹è¿› | æ–°å¢ mod.rs åˆå¹¶æ­¥éª¤å’Œå†…éƒ¨å¯¼å…¥æ›´æ–° |
| 5.3 | ä¿®å¤ | **git mv é¿å…åµŒå¥— + åˆå¹¶ mod.rs åˆ° lib.rs** |
| 5.4 | æ”¹è¿› | æ–°å¢ mod.rs åˆå¹¶æ­¥éª¤å’Œå†…éƒ¨å¯¼å…¥æ›´æ–° |
| 7.1 | æ”¹è¿› | `mv` â†’ `git mv` |
| 8.1 | æ–°å¢ | **ç§»åŠ¨é›†æˆæµ‹è¯•åˆ° piper-sdk**ï¼ˆVirtual Workspace å…³é”®ä¿®å¤ï¼‰ |
| 9.3.1 | æ–°å¢ | **cargo-release workspace é…ç½®**ï¼ˆtag, shared-version, consolidateï¼‰ |
| 9.3.3 | ä¿®å¤ | **æ˜ç¡®ä¸ºæ‰‹åŠ¨å‘å¸ƒæ–¹æ¡ˆï¼Œä½¿ç”¨ `cargo publish`ï¼ˆé¿å…å·¥å…·æ··æ·†ï¼‰** |
| 9.3.4 | æ–°å¢ | **æ˜ç¡®ä¸ºè‡ªåŠ¨å‘å¸ƒæ–¹æ¡ˆï¼Œä½¿ç”¨ `cargo release --workspace`** |
| 9.25 | ä¿®å¤ | **ç§»é™¤ dep: è¯­æ³•ï¼Œæ”¹ç”¨å¹³å°è‡ªåŠ¨é€‰æ‹©é€»è¾‘** |
| 9.26 | æ–°å¢ | æ–‡æ¡£å†…é“¾æ¥æ£€æŸ¥ |
| 9.5 | ä¿®å¤ | **åˆ é™¤é‡å¤å†…å®¹ï¼Œç»Ÿä¸€ä¸ºå•ä¸€åˆå¹¶é˜¶æ®µ** |

### ğŸ“š å‚è€ƒèµ„æº

å®¡æŸ¥è€…ç‰¹åˆ«å‚è€ƒäº†ä»¥ä¸‹èµ„æºï¼š
- [Bevy Engine Workspace](https://github.com/bevyengine/bevy) - å¤§å‹ workspace å®è·µ
- [Embark Studios Workspace](https://github.com/embarkstudios/embark) - ä¼ä¸šçº§ workspace
- [cargo-release å·¥å…·](https://github.com/crate-ci/cargo-release) - è‡ªåŠ¨åŒ–å‘å¸ƒ

---

## ğŸ” æœ€éšè”½çš„é™·é˜±ï¼šVirtual Workspace tests/ é—®é¢˜

### é—®é¢˜æè¿°

å½“ä½ å°†æ ¹ç›®å½•çš„ `Cargo.toml` ä» `[package]` æ”¹ä¸º `[workspace]` æ—¶ï¼ŒCargo ä¼š**è‡ªåŠ¨å¿½ç•¥æ ¹ç›®å½•ä¸‹çš„ `tests/` æ–‡ä»¶å¤¹**ã€‚

### ä¸ºä»€ä¹ˆè¿™æ˜¯é™·é˜±

1. **é™é»˜å¤±è´¥**: ä¸ä¼šæœ‰ä»»ä½•é”™è¯¯æˆ–è­¦å‘Š
2. **è™šå‡å®‰å…¨**: `cargo test` ä¼šæ˜¾ç¤º"æ‰€æœ‰æµ‹è¯•é€šè¿‡"ï¼Œä½†å®é™…ä¸Šé›†æˆæµ‹è¯•æ ¹æœ¬æ²¡è¿è¡Œ
3. **éš¾ä»¥å‘ç°**: åªæœ‰åœ¨æ£€æŸ¥ CI æ—¥å¿—æˆ–æ‰‹åŠ¨è¿è¡Œç‰¹å®šæµ‹è¯•æ—¶æ‰ä¼šå‘ç°

### å…·ä½“ç—‡çŠ¶

```bash
# è¿ç§»å‰ï¼ˆå•ä½“åº“ï¼‰
$ cargo test --test integration_test
running 3 tests
test test_foo ... ok
test test_bar ... ok
test result: ok. 3 passed; 0 failed

# è¿ç§»åï¼ˆVirtual Workspaceï¼Œtests/ æœªç§»åŠ¨ï¼‰
$ cargo test --test integration_test
error: no test target named `integration_test`
# æˆ–è€…å¹²è„†ä»€ä¹ˆéƒ½ä¸è¾“å‡ºï¼ˆå¦‚æœæ˜¯ `cargo test`ï¼‰
```

### è§£å†³æ–¹æ¡ˆ

**åœ¨é˜¶æ®µ 8.1 ä¸­ï¼Œå°†æ ¹ç›®å½•çš„ `tests/` ç§»åŠ¨åˆ° `crates/piper-sdk/tests/`**

```bash
# æ­£ç¡®çš„åšæ³•
mkdir -p crates/piper-sdk/tests
git mv tests/*.rs crates/piper-sdk/tests/

# ç°åœ¨æµ‹è¯•ä» piper-sdk è¿è¡Œ
cargo test -p piper-sdk --test integration_test
```

### ä¸ºä»€ä¹ˆç§»åˆ° piper-sdk

1. **é€»è¾‘å½’å±**: `piper-sdk` æ˜¯æœ€ç»ˆçš„èšåˆåº“ï¼Œæµ‹è¯•å®Œæ•´çš„ SDK API
2. **å‘åå…¼å®¹**: `piper-sdk` é‡æ–°å¯¼å‡ºæ‰€æœ‰å…¶ä»– crates çš„å…¬å…± API
3. **ä¾èµ–å®Œæ•´**: é›†æˆæµ‹è¯•é€šå¸¸éœ€è¦å®Œæ•´çš„ SDK åŠŸèƒ½ï¼Œä¸æ˜¯æµ‹è¯•å•ä¸ªå±‚

### æ£€æŸ¥æ–¹æ³•

åœ¨è¿ç§»å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# åº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰é›†æˆæµ‹è¯•
cargo test -p piper-sdk --all-targets

# æ£€æŸ¥æ ¹ç›®å½• tests/ æ˜¯å¦ä¸ºç©º
ls tests/
# åº”è¯¥è¾“å‡º: ls: tests: No such file or directory
```

---

## âš ï¸ æ·±åº¦ä»£ç å®¡æŸ¥å‘ç°çš„è¯­æ³•é”™è¯¯

### é”™è¯¯ A: workspace.dependencies è¯­æ³•é”™è¯¯

**é—®é¢˜**: åœ¨ `[workspace.dependencies]` ä¸­ä½¿ç”¨äº† `target.'cfg...'` è¯­æ³•ã€‚

```toml
# âŒ é”™è¯¯ï¼ˆè¯­æ³•ä¸æ”¯æŒï¼‰
[workspace.dependencies]
socketcan = "2.0"
[target.'cfg(target_os = "linux")'.dependencies]
socketcan = "2.0"
```

**åŸå› **: `[workspace.dependencies]` ä»…ç”¨äºå£°æ˜ç‰ˆæœ¬å·å˜é‡ï¼Œä¸æ”¯æŒæ¡ä»¶åˆ¤æ–­ã€‚

**ä¿®å¤**: ç§»é™¤æ¡ä»¶è¯­æ³•ï¼Œåœ¨å„ä¸ª crate çš„ `Cargo.toml` ä¸­ä½¿ç”¨æ¡ä»¶ä¾èµ–ã€‚

```toml
# âœ… æ­£ç¡®ï¼ˆæ ¹ Cargo.tomlï¼‰
[workspace.dependencies]
socketcan = "2.0"

# âœ… æ­£ç¡®ï¼ˆcrates/piper-can/Cargo.tomlï¼‰
[target.'cfg(target_os = "linux")'.dependencies]
socketcan = { workspace = true }
```

### é”™è¯¯ B: git mv å¯¼è‡´æ–‡ä»¶å¤¹åµŒå¥—

**é—®é¢˜**: `git mv src/protocol crates/piper-protocol/src/` ä¼šåˆ›å»ºåµŒå¥—ç»“æ„ã€‚

```bash
# æ‰§è¡Œå‰
src/protocol/ids.rs
src/protocol/mod.rs

# æ‰§è¡Œ git mv src/protocol crates/piper-protocol/src/
crates/piper-protocol/src/protocol/ids.rs  # â† åµŒå¥—äº†ï¼
crates/piper-protocol/src/protocol/mod.rs

# lib.rs æœŸæœ›
pub mod ids;  // æœŸæœ› src/ids.rsï¼Œè€Œä¸æ˜¯ src/protocol/ids.rs
```

**ä¿®å¤**: ç§»åŠ¨åè°ƒæ•´å±‚çº§ã€‚

```bash
# 1. ç§»åŠ¨æ•´ä¸ªæ–‡ä»¶å¤¹
git mv src/protocol crates/piper-protocol/src/

# 2. å°†æ–‡ä»¶æå‡ºæ¥
git mv crates/piper-protocol/src/protocol/* crates/piper-protocol/src/
rmdir crates/piper-protocol/src/protocol

# 3. åˆå¹¶ mod.rs åˆ° lib.rs
cat crates/piper-protocol/src/mod.rs >> crates/piper-protocol/src/lib.rs
rm crates/piper-protocol/src/mod.rs

# ç°åœ¨ç»“æ„æ­£ç¡®
crates/piper-protocol/src/ids.rs  # âœ… æ­£ç¡®ä½ç½®
crates/piper-protocol/src/lib.rs  # âœ… åŒ…å«æ¨¡å—å£°æ˜
```

**âš ï¸ é‡è¦**: è¿™ä¸ªä¿®å¤åœ¨é˜¶æ®µ 2.3, 3.3, 4.3, 5.3 ä¸­éƒ½å·²åº”ç”¨ã€‚

---

## ğŸ”´ çº¢é˜Ÿæµ‹è¯•å‘ç°çš„é…ç½®é€»è¾‘ç‘•ç–µ

### é—®é¢˜ 1: `dep:` è¯­æ³•ä¸ `optional = true` çš„é…åˆ

**é”™è¯¯é…ç½®**:
```toml
# features å®šä¹‰
socketcan = ["dep:socketcan"]  # âŒ è¦æ±‚ optional = true

# ä½†ä¾èµ–å®šä¹‰
[target.'cfg(target_os = "linux")'.dependencies]
socketcan = { workspace = true }  # âŒ ç¼ºå°‘ optional = true
```

**åæœ**: `cargo check` ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ° `dep:socketcan`ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
```toml
# âœ… æ­£ç¡®é…ç½®
[features]
socketcan = []  # ä¸ä½¿ç”¨ dep: è¯­æ³•ï¼Œå› ä¸ºä¾èµ–å·²é€šè¿‡ target cfg åŒ…å«

[dependencies]
[target.'cfg(target_os = "linux")'.dependencies]
socketcan = { workspace = true, optional = true }  # âœ… æ·»åŠ  optional
```

**ä¸ºä»€ä¹ˆä¸ç”¨ `dep:` è¯­æ³•**:
- ä¾èµ–å·²ç»é€šè¿‡ `target.'cfg(target_os = "linux")'.dependencies` è‡ªåŠ¨åŒ…å«
- features åªæ˜¯æ ‡è¯†ç¬¦ï¼Œç”¨äºæ˜ç¡®å¯ç”¨å“ªä¸ªåç«¯ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰
- ä¸éœ€è¦å†æ¬¡å¼•ç”¨ä¾èµ–

**åº”ç”¨é˜¶æ®µ**: 3.2, 9.25.1, 9.25.2

---

### é—®é¢˜ 2: å‘å¸ƒæµç¨‹å·¥å…·æ··æ·†

**é”™è¯¯æè¿°**: é˜¶æ®µ 9.3.3 è¯´æ˜¯"æ‰‹åŠ¨å‘å¸ƒ"ï¼Œä½†ç”¨çš„å‘½ä»¤æ˜¯ `cargo release`ï¼ˆå·¥å…·å‘½ä»¤ï¼‰ã€‚

**é£é™©**: å¦‚æœé…ç½®äº† `shared-version = true`ï¼Œåœ¨å­ç›®å½•è¿è¡Œ `cargo release` å¯èƒ½å¯¼è‡´å·¥å…·å›°æƒ‘ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- **é˜¶æ®µ 9.3.3**: æ˜ç¡®ä¸º"æ‰‹åŠ¨å‘å¸ƒå¤‡é€‰æ–¹æ¡ˆ"ï¼Œä½¿ç”¨ `cargo publish`ï¼ˆRust åŸç”Ÿå‘½ä»¤ï¼‰
- **é˜¶æ®µ 9.3.4**: æ˜ç¡®ä¸º"è‡ªåŠ¨å‘å¸ƒæ¨èæ–¹æ¡ˆ"ï¼Œä½¿ç”¨ `cargo release --workspace`ï¼ˆå·¥å…·å‘½ä»¤ï¼‰

**å¯¹æ¯”**:
| æ–¹æ¡ˆ | å‘½ä»¤ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| æ‰‹åŠ¨å‘å¸ƒ | `cargo publish` | ä¸ä¾èµ–å·¥å…·é…ç½®ï¼Œå®Œå…¨å¯æ§ | éœ€è¦æ‰‹åŠ¨ç­‰å¾… crates.io ç´¢å¼• |
| è‡ªåŠ¨å‘å¸ƒ | `cargo release --workspace` | ä¸€é”®å®Œæˆï¼Œè‡ªåŠ¨æ‹“æ‰‘æ’åº | éœ€è¦æ­£ç¡®é…ç½® workspace |

**åº”ç”¨é˜¶æ®µ**: 9.3.3, 9.3.4

---

## ğŸ“– ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Cargo Workspaces](https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html)
- [Workspace å‘å¸ƒ](https://doc.rust-lang.org/cargo/reference/publishing.html#workspaces)

### æœ€ä½³å®è·µ
- [Large Rust Projects](https://users.rust-lang.org/t/tips-for-large-rust-projects-with-a-workflow/2734)
- [Bevy Workspace](https://github.com/bevyengine/bevy) (å‚è€ƒå®ç°)

### æœ¬é¡¹ç›®æ–‡æ¡£
- [Pipeline è®¾è®¡](../pipeline_design.md)
- [Position Control ç”¨æˆ·æŒ‡å—](../position_control_user_guide.md)

---

## ğŸ¤ è´¡çŒ®

å¦‚æœä½ å¯¹ workspace é‡æ„æœ‰å»ºè®®æˆ–å‘ç°é—®é¢˜ï¼š

1. æŸ¥çœ‹ [åˆ†ææŠ¥å‘Š](./analysis_report.md) äº†è§£å…¨å±€æƒ…å†µ
2. åœ¨é¡¹ç›®ä¸­æå‡º Issue æˆ– PR
3. è”ç³»ç»´æŠ¤å›¢é˜Ÿè®¨è®º

---

## ğŸ“… æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | æ–‡æ¡£ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2026-01-25 | å…¨éƒ¨ | åˆå§‹ç‰ˆæœ¬ |
| - | analysis_report.md | å®ŒæˆæŠ€æœ¯åˆ†æ |
| - | migration_plan.md | å®Œæˆè¿ç§»è®¡åˆ’ |
| - | architecture_decision_record.md | å®Œæˆå†³ç­–è®°å½• |

---

**æœ€åæ›´æ–°**: 2026-01-25
**ç»´æŠ¤è€…**: Piper SDK å›¢é˜Ÿ
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œå¾…å®æ–½
