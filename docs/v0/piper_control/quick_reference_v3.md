# Piper Control åˆ†æå¿«é€Ÿå‚è€ƒï¼ˆv3.2 æœ€ç»ˆä¿®æ­£ç‰ˆï¼‰

**âš ï¸ v3.2 æœ€ç»ˆä¿®æ­£**: æ ¹æ®ç”¨æˆ·åé¦ˆè¿›è¡Œå…¨é¢ä¿®æ­£ + Day 2 å·¥ç¨‹åŒ–å¢å¼º + ç‰©ç†ä¿®æ­£

---

## ä¸€å¥è¯æ€»ç»“

**Python `piper_control` å‚è€ƒå®ç°ä¸»è¦åœ¨é«˜å±‚æ§åˆ¶æŠ½è±¡å’Œå®ç”¨å·¥å…·æ–¹é¢å€¼å¾—å€Ÿé‰´ï¼Œç»è¿‡ **3 è½®è¿­ä»£ + 1 è½®å·¥ç¨‹åŒ–å¢å¼º + 1 è½®ç‰©ç†ä¿®æ­£**ï¼Œç°å·²è¾¾åˆ°**ç”Ÿäº§çº§ Rust SDK è®¾è®¡è§„èŒƒ**ï¼š

- âœ… `park()` è¿”è¿˜ `Piper<Standby>`ï¼Œæ”¯æŒçŠ¶æ€æµè½¬
- âœ… ä½¿ç”¨ `spin_sleep` + **ç»å¯¹æ—¶é—´é”šç‚¹** ä¿è¯ 200Hz Â±1Hz
- âœ… Option æ¨¡å¼é¿å… `mem::forget`
- âœ… **â­ v3.1: å®¹é”™æ€§å¢å¼º**ï¼ˆæ”¯æŒå¶å‘ä¸¢å¸§ï¼‰
- âœ… **â­ v3.1: GUI å‹å¥½**ï¼ˆå¤šç§ Token æ„é€ æ–¹å¼ï¼‰
- âœ… **â­ v3.1: è½¯é™çº§ç­–ç•¥**ï¼ˆå…¼å®¹éæ ‡å‡†ç‰ˆæœ¬ï¼‰
- âœ… **â­â­ v3.2: å¾ªç¯é”šç‚¹**ï¼ˆæ¶ˆé™¤ç´¯ç§¯æ¼‚ç§»ï¼‰â­â­â­

---

## ğŸš¨ v3.2 å…³é”®ä¿®æ­£ï¼šå¾ªç¯æ¼‚ç§»é—®é¢˜

### é—®é¢˜ï¼ˆv3.1ï¼‰

```rust
// âŒ v3.1: æœ‰ç´¯ç§¯æ¼‚ç§»
let sleep_duration = Duration::from_secs_f64(1.0 / 200.0);  // 5ms

while start.elapsed() < timeout {
    self.command_joints(...)?;  // å‡è®¾è€—æ—¶ 0.5ms
    spin_sleep::sleep(sleep_duration);  // å›ºå®šç¡çœ  5ms
}

// å®é™…å¾ªç¯å‘¨æœŸ = 0.5ms + 5ms = 5.5ms
// å®é™…é¢‘ç‡ = 1000ms / 5.5ms â‰ˆ 181Hz âŒ (è€Œéé¢„æœŸçš„ 200Hz)
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ ç´¯ç§¯æ¼‚ç§»ï¼šæ¯å‘¨æœŸå¤šå‡ºçš„ `T_cmd` æ—¶é—´ä¼šç´¯ç§¯
- âŒ é¢‘ç‡ä¸ç¨³å®šï¼šä¾èµ– CAN å‘é€è€—æ—¶ï¼Œå¯¼è‡´æ§åˆ¶é¢‘ç‡æ³¢åŠ¨

### è§£å†³æ–¹æ¡ˆï¼ˆv3.2ï¼‰â­

```rust
// âœ… v3.2: é”šç‚¹æœºåˆ¶ï¼ˆæ¶ˆé™¤æ¼‚ç§»ï¼‰
let period = Duration::from_secs_f64(1.0 / 200.0);  // 5ms
let mut next_tick = Instant::now();

while start.elapsed() < timeout {
    next_tick += period;  // è®¾å®šä¸‹ä¸€ä¸ªé”šç‚¹

    self.command_joints(...)?;  // è€—æ—¶æ“ä½œ

    // ç¡çœ åˆ°ä¸‹ä¸€ä¸ªé”šç‚¹ï¼ˆè‡ªåŠ¨æ‰£é™¤è€—æ—¶ï¼‰
    let now = Instant::now();
    if next_tick > now {
        spin_sleep::sleep(next_tick - now);  // å‰©ä½™æ—¶é—´ç¡çœ 
    } else {
        warn!("Overrun! Skipping sleep to catch up.");
        next_tick = now;  // è¿½èµ¶é”šç‚¹
    }
}

// å®é™…é¢‘ç‡ = 1000ms / 5ms = 200Hz âœ… (ç²¾ç¡®ä¸”ç¨³å®š)
```

**æ”¶ç›Š**ï¼š
- ğŸ¯ **ç²¾ç¡®é¢‘ç‡**ï¼š200Hz Â±1Hzï¼ˆv3.1: 181Hzï¼‰
- ğŸ›¡ï¸ **é²æ£’æ€§**ï¼šæ”¯æŒä»»åŠ¡è€—æ—¶æ³¢åŠ¨
- ğŸ”§ **ç¨³å®šæ€§**ï¼šæ¶ˆé™¤å¾ªç¯ç´¯ç§¯æ¼‚ç§»

---

## v3.2 å…¨éƒ¨ 9 ä¸ªä¼˜åŒ–ç‚¹

### v3.0 æ ¸å¿ƒä¼˜åŒ–ï¼ˆ5 ä¸ªï¼‰

1. **ğŸ”„ çŠ¶æ€æµè½¬**ï¼š`park()` è¿”è¿˜ `Piper<Standby>`
2. **â±ï¸ å¾ªç¯ç²¾åº¦**ï¼š`spin_sleep` ä¿è¯ <1ms æŠ–åŠ¨
3. **ğŸ›¡ï¸ èµ„æºç®¡ç†**ï¼šOption æ¨¡å¼
4. **ğŸ“ é¡¹ç›®ç»“æ„**ï¼šWorkspace
5. **ğŸ”Œ ç‰ˆæœ¬è§£æ**ï¼š`semver`

### v3.1 å·¥ç¨‹åŒ–å¢å¼ºï¼ˆ3 ä¸ªï¼‰

6. **ğŸ›¡ï¸ å®¹é”™æ€§**ï¼šè¿ç»­é”™è¯¯è®¡æ•°å™¨
7. **ğŸ¯ Token**ï¼š`unsafe fn new_unchecked()`
8. **ğŸ”§ è½¯é™çº§**ï¼šç‰ˆæœ¬è§£æå¤±è´¥ä¸é˜»æ–­

### v3.2 ç‰©ç†ä¿®æ­£ï¼ˆ1 ä¸ªï¼‰â­

9. **ğŸ¯ å¾ªç¯é”šç‚¹**ï¼šæ¶ˆé™¤ç´¯ç§¯æ¼‚ç§»ï¼Œä¿è¯ç²¾ç¡® 200Hz â­â­â­

---

## å…³é”®ä»£ç å¯¹æ¯”ï¼ˆv3.2ï¼‰

### å¾ªç¯é”šç‚¹ä¿®æ­£

```rust
// âŒ v3.1: æœ‰æ¼‚ç§»
while start.elapsed() < timeout {
    self.command_joints(...)?;
    spin_sleep::sleep(Duration::from_secs_f64(1.0 / 200.0));
    // å®é™…é¢‘ç‡ 181Hz âŒ
}

// âœ… v3.2: é”šç‚¹æœºåˆ¶ï¼ˆç²¾ç¡® 200Hzï¼‰
let period = Duration::from_secs_f64(1.0 / 200.0);  // 5ms
let mut next_tick = Instant::now();

while start.elapsed() < timeout {
    next_tick += period;  // ç»å¯¹é”šç‚¹
    self.command_joints(...)?;

    // ç¡çœ åˆ°ä¸‹ä¸€ä¸ªé”šç‚¹ï¼ˆè‡ªåŠ¨æ‰£é™¤è€—æ—¶ï¼‰
    let now = Instant::now();
    if next_tick > now {
        spin_sleep::sleep(next_tick - now);
    } else {
        warn!("Overrun! Skipping sleep to catch up.");
        next_tick = now;
    }
    // å®é™…é¢‘ç‡ 200Hz âœ…
}
```

---

## ä½¿ç”¨ç¤ºä¾‹ï¼ˆv3.2ï¼‰

```rust
use piper_sdk::prelude::*;

let piper = PiperBuilder::new()?
    .connect("can0")?
    .enable(MitMode::default(), EnableConfig::default())?;

let config = MitControllerConfig {
    kp_gains: [RadPerSec(5.0); 6],
    kd_gains: [NewtonMeterPerRadPerSec(0.8); 6],
    rest_position: Some(ArmOrientations::UPRIGHT.rest_position),
    control_rate: 200.0,  // âš ï¸ ç²¾ç¡® 200Hz
};

let mut controller = MitController::new(piper, config)?;

// âš ï¸ v3.2: é”šç‚¹æœºåˆ¶ï¼Œä¿è¯ç²¾ç¡® 200Hzï¼ˆæ— è®º CAN è€—æ—¶å¤šå°‘ï¼‰
controller.move_to_position(
    [Rad(0.5), Rad(0.7), Rad(-0.4), Rad(0.2), Rad(0.3), Rad(0.5)],
    Rad(0.01),
    Duration::from_secs(5.0),
)?;

// æ˜¾å¼åœè½¦ï¼ˆè¿”è¿˜ Piper<Standby>ï¼‰
let piper_standby = controller.park()?;
```

---

## æ€§èƒ½å¯¹æ¯”ï¼ˆv3.2 vs Pythonï¼‰

| æŒ‡æ ‡ | Python | Rust SDK (v3.1) | Rust SDK (v3.2) | æ”¹è¿› |
|------|--------|-----------------|-----------------|------|
| **æ§åˆ¶é¢‘ç‡** | ~200Hz | ~181Hz (æœ‰æ¼‚ç§») | **~200Hz** (ç²¾ç¡®) | â­ v3.2 ä¿®æ­£ |
| **ç´¯ç§¯æ¼‚ç§»** | âŒ æœ‰ | âŒ æœ‰ | **âœ… æ— ** | â­ v3.2 æ¶ˆé™¤ |
| **å®¹é”™æ€§** | âŒ Fail-Fast | âœ… å…è®¸ 5 å¸§ä¸¢å¸§ | âœ… åŒ v3.1 | ä¿æŒ |
| **çŠ¶æ€æµè½¬** | âŒ | âœ… | âœ… | ä¿æŒ |
| **GUI å‹å¥½** | âš ï¸ ä»…ç¯å¢ƒå˜é‡ | âœ… å¤šç§æ–¹å¼ | âœ… | ä¿æŒ |
| **å…¼å®¹æ€§** | âš ï¸ ç¡¬ç¼–ç  | âœ… è½¯é™çº§ | âœ… | ä¿æŒ |

---

## å®æ–½è·¯çº¿å›¾ï¼ˆv3.2ï¼‰

### Week 1-2: æ ¸å¿ƒå¯é æ€§

- [ ] **MitController (2-3 å¤©)** âš ï¸ **v3.2 é”šç‚¹ä¿®æ­£**
  - [ ] Option<Piper> ç»“æ„
  - [ ] `move_to_position()`ï¼ˆâš ï¸ **ç»å¯¹æ—¶é—´é”šç‚¹**ï¼‰
  - [ ] `park()`ï¼ˆè¿”è¿˜ Piper<Standby>ï¼‰
  - [ ] `relax_joints()`ï¼ˆè½¯é™çº§ï¼‰
  - [ ] `Drop`ï¼ˆOption æ¨¡å¼ï¼‰
  - [ ] å•å…ƒæµ‹è¯•ï¼ˆâš ï¸ **é¢‘ç‡æµ‹è¯•**ï¼‰

- [ ] **ZeroingConfirmToken (0.5 å¤©)**
  - [ ] `confirm_from_env()`
  - [ ] `unsafe fn new_unchecked()`
  - [ ] `confirm_for_test()`

- [ ] Workspace é…ç½®
- [ ] å…¶ä»–åŠŸèƒ½

**æ€»è®¡**: ~6 å¤©

---

## æ–‡æ¡£ç‰ˆæœ¬å†å²

- **v3.0**: 5 ä¸ªå…³é”®ä¼˜åŒ–ï¼ˆçŠ¶æ€æµè½¬ã€ç²¾åº¦ã€èµ„æºç®¡ç†ã€é¡¹ç›®ç»“æ„ã€ç‰ˆæœ¬è§£æï¼‰
- **v3.1**: 3 ä¸ªå·¥ç¨‹åŒ–å¢å¼ºï¼ˆå®¹é”™æ€§ã€Token æ„é€ ã€è½¯é™çº§ï¼‰
- **v3.2**: 1 ä¸ªç‰©ç†ä¿®æ­£ï¼ˆå¾ªç¯é”šç‚¹ï¼‰â­â­â­ **æ¶ˆé™¤é¢‘ç‡æ¼‚ç§»**

---

## ğŸ æœ€ç»ˆè¯„å®¡

âœ… **æ¶æ„å®Œç¾ï¼Œå†»ç»“å®æ–½**

**9 ä¸ªä¼˜åŒ–ç‚¹**ï¼š
1. ğŸ”„ çŠ¶æ€æµè½¬
2. â±ï¸ å¾ªç¯ç²¾åº¦ï¼ˆspin_sleepï¼‰
3. ğŸ›¡ï¸ èµ„æºç®¡ç†ï¼ˆOptionï¼‰
4. ğŸ“ Workspace
5. ğŸ”Œ ç‰ˆæœ¬è§£æï¼ˆsemverï¼‰
6. ğŸ›¡ï¸ å®¹é”™æ€§
7. ğŸ¯ Token æ„é€ 
8. ğŸ”§ è½¯é™çº§
9. ğŸ¯ å¾ªç¯é”šç‚¹ â­

**ç‰©ç†æ­£ç¡®æ€§**ï¼š
- ğŸ¯ æ§åˆ¶é¢‘ç‡ï¼š200Hz Â±1Hzï¼ˆv3.1: 181Hzï¼‰
- ğŸ›¡ï¸ å®¹é”™æ€§ï¼šå…è®¸å¶å‘ä¸¢å¸§
- ğŸ”§ å…¼å®¹æ€§ï¼šæ”¯æŒéæ ‡å‡†ç‰ˆæœ¬å·
- ğŸ¯ GUI å‹å¥½ï¼šå¤šç§ç¡®è®¤æ–¹å¼
- âœ¨ **ç¨³å®šæ€§**ï¼šæ¶ˆé™¤ç´¯ç§¯æ¼‚ç§»

---

**æœ€åæ›´æ–°**: 2026-01-26
**ç‰ˆæœ¬**: 3.2 (æœ€ç»ˆä¿®æ­£ç‰ˆ)
**çŠ¶æ€**: â­â­â­ ç”Ÿäº§å°±ç»ª
