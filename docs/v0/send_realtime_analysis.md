# `send_realtime` è®¾è®¡åˆ†ææŠ¥å‘Š

**ç‰ˆæœ¬**: v0.0.3
**æ—¥æœŸ**: 2026-01-26
**ä½œè€…**: Claude Code

---

## 1. æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒç»“è®º

**`send_realtime` è®¾è®¡æ˜¯å¿…è¦ä¸”åˆç†çš„ï¼Œä½†å½“å‰å®ç°å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š**

âœ… **ä¼˜ç‚¹**ï¼š
- ä¸ºé«˜é¢‘åŠ›æ§åœºæ™¯ï¼ˆ500Hz-1kHzï¼‰æä¾›äº†é›¶é˜»å¡å‘é€æœºåˆ¶
- é‚®ç®±æ¨¡å¼ï¼ˆMailbox Patternï¼‰ç¡®ä¿æ§åˆ¶æŒ‡ä»¤å§‹ç»ˆæ˜¯æœ€æ–°çš„
- ä¸å¯é é˜Ÿåˆ—ï¼ˆFIFOï¼‰å½¢æˆäº’è¡¥çš„åŒé‡è°ƒåº¦æœºåˆ¶

âš ï¸ **é—®é¢˜**ï¼š
- **æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä½¿ç”¨ `send_realtime`ï¼ŒåŒ…æ‹¬ä½ç½®æ§åˆ¶**ï¼Œè¿™ä¸åˆç†
- **ç¼ºä¹ç±»å‹ç³»ç»Ÿæˆ–é…ç½®æœºåˆ¶æ¥æ§åˆ¶å‘é€ç­–ç•¥**
- **åºåˆ—æŒ‡ä»¤ï¼ˆè½¨è¿¹æ§åˆ¶ï¼‰éš¾ä»¥ä¿è¯å®Œæ•´æ€§**

ğŸ¯ **å»ºè®®**ï¼š
- **é€šè¿‡ Type State Pattern åŒºåˆ†å‘é€ç­–ç•¥**
- **MIT æ¨¡å¼ä½¿ç”¨ `send_realtime`ï¼ˆå¯ä¸¢å¼ƒï¼‰**
- **Position æ¨¡å¼ä½¿ç”¨ `send_reliable`ï¼ˆå¯é é˜Ÿåˆ—ï¼‰**
- **æ·»åŠ é…ç½®é€‰é¡¹å…è®¸ç”¨æˆ·æƒè¡¡å»¶è¿Ÿä¸å¯é æ€§**

---

## 2. å½“å‰è®¾è®¡åˆ†æ

### 2.1 æ¶æ„æ¦‚è§ˆ

å½“å‰ Piper SDK å®ç°äº†**åŒçº¿ç¨‹ IO æ¶æ„** + **å‘½ä»¤ä¼˜å…ˆçº§è°ƒåº¦ç³»ç»Ÿ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ä»£ç  (Client Layer)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Piper<Active<MitMode>>                                   â”‚
â”‚  â”œâ”€â”€ command_torques() â†’ send_realtime_package() âœ…        â”‚
â”‚  â””â”€â”€ å…¶ä»–æ–¹æ³• â†’ send_reliable()                             â”‚
â”‚                                                               â”‚
â”‚  Piper<Active<PositionMode>>                               â”‚
â”‚  â”œâ”€â”€ command_position() â†’ send_realtime_package() âš ï¸         â”‚
â”‚  â”œâ”€â”€ send_position_command() â†’ send_realtime_package() âš ï¸   â”‚
â”‚  â””â”€â”€ é…ç½®å‘½ä»¤ â†’ send_reliable() âœ…                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Driver Layer (Piper)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  ä¸¤ä¸ªå‘é€é€šé“ï¼š                                                â”‚
â”‚  1. realtime_slot (Mutex<Option<RealtimeCommand>>)          â”‚
â”‚     - é‚®ç®±æ¨¡å¼ï¼ŒLast Write Wins                            â”‚
â”‚     - send_realtime() / send_realtime_package()             â”‚
â”‚     - æ— é˜»å¡ï¼Œå¯è¦†ç›–                                          â”‚
â”‚                                                               â”‚
â”‚  2. reliable_tx (crossbeam_channel::Sender<PiperFrame>)    â”‚
â”‚     - FIFO é˜Ÿåˆ—ï¼ˆå®¹é‡ 10ï¼‰                                    â”‚
â”‚     - send_reliable() / send_command()                      â”‚
â”‚     - é˜»å¡ç­‰å¾…ï¼ŒFIFO                                         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TX Thread (Priority Scheduler)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  loop {                                                        â”‚
â”‚      // Priority 1: æ£€æŸ¥ realtime_slot (æœ€å¤šè¿ç»­å¤„ç† 100 ä¸ª)  â”‚
â”‚      if let Some(cmd) = realtime_slot.lock().take() {        â”‚
â”‚          send(cmd.frames);  // é‚®ç®±æ¨¡å¼ï¼Œç›´æ¥è¦†ç›–            â”‚
â”‚          if burst_count < 100 { continue; }  // é¥¿æ­»ä¿æŠ¤      â”‚
â”‚      }                                                         â”‚
â”‚                                                               â”‚
â”‚      // Priority 2: æ£€æŸ¥ reliable_rx                        â”‚
â”‚      if let Ok(frame) = reliable_rx.try_recv() {              â”‚
â”‚          send(frame);  // FIFO é˜Ÿåˆ—ï¼ŒæŒ‰é¡ºåº                 â”‚
â”‚      }                                                         â”‚
â”‚  }                                                             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸¤ç§å‘é€æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | `send_realtime` | `send_reliable` |
|------|-----------------|-----------------|
| **é˜Ÿåˆ—ç±»å‹** | é‚®ç®±ï¼ˆ1 æ’æ§½ï¼‰ | FIFOï¼ˆ10 å®¹é‡ï¼‰ |
| **å‘é€ç­–ç•¥** | Last Write Wins | FIFO |
| **é˜»å¡è¡Œä¸º** | æ— é˜»å¡ï¼Œç«‹å³è¿”å› | é˜»å¡ç­‰å¾…ï¼ˆå¸¦è¶…æ—¶ï¼‰ |
| **è¦†ç›–é£é™©** | é«˜ï¼ˆæ–°å‘½ä»¤è¦†ç›–æ—§å‘½ä»¤ï¼‰ | æ— ï¼ˆæŒ‰é¡ºåºå‘é€ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | é«˜é¢‘åŠ›æ§ï¼ˆ500Hz+ï¼‰ | é…ç½®ã€çŠ¶æ€åˆ‡æ¢ |
| **å»¶è¿Ÿ** | æä½ï¼ˆ<1Î¼sï¼‰ | ä½ï¼ˆé˜Ÿåˆ—ç­‰å¾…ï¼‰ |
| **å¯é æ€§** | ä½ï¼ˆå¯èƒ½ä¸¢åŒ…ï¼‰ | é«˜ï¼ˆä¿è¯å‘é€ï¼‰ |

### 2.3 å½“å‰ä½¿ç”¨æƒ…å†µ

#### âœ… **åˆç†ä½¿ç”¨ï¼šMIT æ¨¡å¼**

```rust
// crates/piper-client/src/raw_commander.rs:107
pub(crate) fn send_mit_command_batch(...) {
    // å‡†å¤‡æ‰€æœ‰ 6 ä¸ªå…³èŠ‚çš„å¸§
    let frames_array: [PiperFrame; 6] = [...];

    // âœ… ä½¿ç”¨ send_realtime_package - æ­£ç¡®ï¼
    self.driver.send_realtime_package(frames_array)?;
}
```

**ä¸ºä»€ä¹ˆåˆç†ï¼Ÿ**
- MIT åŠ›æ§æ˜¯**é«˜é¢‘æ§åˆ¶**ï¼ˆ500Hz-1kHzï¼‰
- æ¯ä¸ªå‘¨æœŸçš„å‘½ä»¤éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæœ€æ–°çš„å‘½ä»¤æœ€é‡è¦
- å¶å°”ä¸¢åŒ…æ˜¯å¯ä»¥æ¥å—çš„ï¼ˆä¸‹ä¸€å‘¨æœŸä¼šçº æ­£ï¼‰

#### âš ï¸ **é—®é¢˜ä½¿ç”¨ï¼šPosition æ¨¡å¼**

```rust
// crates/piper-client/src/state/machine.rs:1039
pub fn send_position_command(&self, positions: &JointArray<Rad>) -> Result<()> {
    let raw = RawCommander::new(&self.driver);

    // âš ï¸ ä½¿ç”¨ send_realtime_package - ä¸åˆç†ï¼
    raw.send_position_command_batch(positions)
}
```

**ä¸ºä»€ä¹ˆä¸åˆç†ï¼Ÿ**
- ä½ç½®æ§åˆ¶å¯èƒ½æ˜¯**åºåˆ—æŒ‡ä»¤**ï¼ˆè½¨è¿¹æ§åˆ¶ï¼‰
- ä½ç½®å‘½ä»¤å¿…é¡»**æŒ‰é¡ºåºæ‰§è¡Œ**ï¼Œä¸èƒ½ä¸¢å¤±
- è¦†ç›–ä¼šå¯¼è‡´éƒ¨åˆ†å…³èŠ‚æœªåˆ°è¾¾ç›®æ ‡ä½ç½®

---

## 3. é—®é¢˜åˆ†æ

### 3.1 æ ¸å¿ƒé—®é¢˜ï¼šç¼ºä¹å‘é€ç­–ç•¥æ§åˆ¶

**é—®é¢˜ 1ï¼šæ‰€æœ‰å‘½ä»¤éƒ½ä½¿ç”¨ `send_realtime`**

å½“å‰å®ç°ä¸­ï¼Œ`RawCommander` çš„æ‰€æœ‰æ‰¹é‡å‘é€æ–¹æ³•éƒ½ä½¿ç”¨ `send_realtime_package`ï¼š

```rust
// RawCommander çš„æ‰€æœ‰æ–¹æ³•éƒ½ä½¿ç”¨ send_realtime_package
send_mit_command_batch()       â†’ send_realtime_package âœ…
send_position_command_batch()   â†’ send_realtime_package âŒ
send_cartesian_command_batch()  â†’ send_realtime_package âŒ
```

**é—®é¢˜ 2ï¼šåºåˆ—æŒ‡ä»¤éš¾ä»¥æ§åˆ¶**

å‡è®¾ç”¨æˆ·æƒ³æ‰§è¡Œè½¨è¿¹æ§åˆ¶ï¼ˆ100 ä¸ªç‚¹ï¼‰ï¼š

```rust
// ç”¨æˆ·æœŸæœ›ï¼šæŒ‰é¡ºåºå‘é€ 100 ä¸ªä½ç½®å‘½ä»¤
for point in trajectory {
    robot.send_position_command(&point)?;  // å®é™…ä½¿ç”¨ realtime
    thread::sleep(Duration::from_millis(10));  // æ‰‹åŠ¨å»¶è¿Ÿ
}
```

**é£é™©**ï¼š
1. **è¦†ç›–é£é™©**ï¼šå¦‚æœç”¨æˆ·å‘é€é€Ÿåº¦ > TX çº¿ç¨‹å¤„ç†é€Ÿåº¦ï¼Œåé¢çš„å‘½ä»¤ä¼šè¦†ç›–å‰é¢çš„
2. **ä¸å¯é **ï¼šæ— æ³•ä¿è¯æ¯ä¸ªç‚¹éƒ½è¢«å‘é€åˆ° CAN æ€»çº¿
3. **æ— åé¦ˆ**ï¼šæ— æ³•çŸ¥é“å“ªäº›å‘½ä»¤è¢«ä¸¢å¼ƒäº†

### 3.2 ç”¨æˆ·çš„ä¸¤éš¾å›°å¢ƒ

#### åœºæ™¯ Aï¼šé«˜é¢‘åŠ›æ§ï¼ˆMIT æ¨¡å¼ï¼‰

**éœ€æ±‚**ï¼š
- é¢‘ç‡ï¼š500Hz-1kHzï¼ˆæ¯ 1-2ms ä¸€æ¬¡ï¼‰
- å»¶è¿Ÿè¦æ±‚ï¼š< 100Î¼s
- å¯é æ€§è¦æ±‚ï¼šå¶å°”ä¸¢åŒ…å¯æ¥å—ï¼Œå¿…é¡»ä¿è¯ä½å»¶è¿Ÿ

**å½“å‰æ–¹æ¡ˆ**ï¼šâœ… ä½¿ç”¨ `send_realtime_package` å®Œç¾æ»¡è¶³

#### åœºæ™¯ Bï¼šè½¨è¿¹æ§åˆ¶ï¼ˆPosition æ¨¡å¼ï¼‰

**éœ€æ±‚**ï¼š
- é¢‘ç‡ï¼š10-100Hzï¼ˆæ¯ 10-100ms ä¸€æ¬¡ï¼‰
- å»¶è¿Ÿè¦æ±‚ï¼š< 10ms
- å¯é æ€§è¦æ±‚ï¼š**å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸èƒ½ä¸¢åŒ…**

**å½“å‰æ–¹æ¡ˆ**ï¼šâŒ ä½¿ç”¨ `send_realtime_package` ä¸æ»¡è¶³

### 3.3 å½“å‰è®¾è®¡çš„ä¼˜ç¼ºç‚¹

#### âœ… ä¼˜ç‚¹

1. **æä½å»¶è¿Ÿ**ï¼šé‚®ç®±æ¨¡å¼æ— é”ç«äº‰ï¼Œå‘é€å»¶è¿Ÿ < 1Î¼s
2. **é›¶é˜»å¡**ï¼šæ°¸ä¸é˜»å¡ï¼Œé€‚åˆé«˜é¢‘æ§åˆ¶å¾ªç¯
3. **è‡ªåŠ¨ä¸¢å¼ƒ**ï¼šæ—§å‘½ä»¤è‡ªåŠ¨è¢«æ–°å‘½ä»¤æ›¿æ¢ï¼Œç¬¦åˆ"æœ€æ–°æ§åˆ¶"è¯­ä¹‰
4. **é¥¥é¥¿ä¿æŠ¤**ï¼šTX çº¿ç¨‹æ¯å¤„ç† 100 ä¸ª realtime å‘½ä»¤åï¼Œå¼ºåˆ¶æ£€æŸ¥ä¸€æ¬¡ reliable é˜Ÿåˆ—

#### âŒ ç¼ºç‚¹

1. **è¿‡åº¦ä½¿ç”¨**ï¼šä½ç½®æ§åˆ¶ä¹Ÿä½¿ç”¨ realtimeï¼Œä¸é€‚åˆåºåˆ—æŒ‡ä»¤
2. **ç¼ºä¹æ§åˆ¶**ï¼šç”¨æˆ·æ— æ³•é€‰æ‹©å‘é€ç­–ç•¥
3. **ç±»å‹ä¸å®‰å…¨**ï¼šç¼–è¯‘æœŸæ— æ³•åŒºåˆ†å“ªäº›æ–¹æ³•ä½¿ç”¨ realtime
4. **ç›‘æ§å›°éš¾**ï¼šè¦†ç›–ç‡é«˜æ—¶æ— æ³•è¿½è¸ª

---

## 4. æ”¹è¿›æ–¹æ¡ˆ

### 4.1 æ–¹æ¡ˆ Aï¼šType State Pattern åŒºåˆ†å‘é€ç­–ç•¥ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡ Rust ç±»å‹ç³»ç»Ÿåœ¨ç¼–è¯‘æœŸå¼ºåˆ¶åŒºåˆ†å‘é€ç­–ç•¥

```rust
impl Piper<Active<MitMode>> {
    /// MIT åŠ›æ§ï¼šä½¿ç”¨ realtimeï¼ˆå¯ä¸¢å¼ƒï¼‰
    pub fn command_torques(...) -> Result<()> {
        // âœ… ä½¿ç”¨ send_realtime_package
        self.driver.send_realtime_package(frames)
    }
}

impl Piper<Active<PositionMode>> {
    /// ä½ç½®æ§åˆ¶ï¼šä½¿ç”¨ reliableï¼ˆå¯é é˜Ÿåˆ—ï¼‰
    pub fn send_position_command(...) -> Result<()> {
        // âœ… ä½¿ç”¨ send_reliable
        self.driver.send_reliable_package(frames)
    }

    /// é«˜çº§ APIï¼šè½¨è¿¹æ§åˆ¶ï¼ˆè‡ªåŠ¨å¤„ç†åºåˆ—ï¼‰
    pub fn execute_trajectory(&self, trajectory: &[JointArray<Rad>]) -> Result<()> {
        for point in trajectory {
            self.send_position_command(point)?;
            self.wait_for_arrival(point)?;  // ç­‰å¾…åˆ°ä½
        }
        Ok(())
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç¼–è¯‘æœŸç±»å‹å®‰å…¨
- âœ… API è¯­ä¹‰æ¸…æ™°
- âœ… é›¶è¿è¡Œæ—¶å¼€é”€

**ç¼ºç‚¹**ï¼š
- âš ï¸ API ä¸å…¼å®¹ï¼ˆBreaking Changeï¼‰

### 4.2 æ–¹æ¡ˆ Bï¼šé…ç½®å‚æ•°æ§åˆ¶å‘é€ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨ `PositionModeConfig` ä¸­æ·»åŠ å‘é€ç­–ç•¥é€‰é¡¹

```rust
pub struct PositionModeConfig {
    pub timeout: Duration,
    pub debounce_threshold: u32,
    pub poll_interval: Duration,
    pub speed_percent: u8,
    pub install_position: InstallPosition,
    pub motion_type: MotionType,

    // ğŸ†• æ–°å¢ï¼šå‘é€ç­–ç•¥
    pub send_strategy: SendStrategy,  // è§ä¸‹æ–¹å®šä¹‰
}

pub enum SendStrategy {
    /// å®æ—¶æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œå…¼å®¹ MIT æ¨¡å¼ï¼‰
    ///
    /// - é‚®ç®±æ¨¡å¼ï¼ŒLast Write Wins
    /// - é€‚ç”¨äºé«˜é¢‘æ§åˆ¶ï¼ˆ500Hz+ï¼‰
    /// - é£é™©ï¼šå‘½ä»¤å¯èƒ½è¢«è¦†ç›–
    Realtime,

    /// å¯é æ¨¡å¼ï¼ˆæ¨èç”¨äºè½¨è¿¹æ§åˆ¶ï¼‰
    ///
    /// - FIFO é˜Ÿåˆ—ï¼ŒæŒ‰é¡ºåºå‘é€
    /// - é€‚ç”¨äºåºåˆ—æŒ‡ä»¤ï¼ˆ10-100Hzï¼‰
    /// - ä¿è¯ï¼šä¸ä¼šä¸¢åŒ…
    Reliable {
        /// å‘é€è¶…æ—¶ï¼ˆé»˜è®¤ 10msï¼‰
        timeout: Duration,
    },
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å‘åå…¼å®¹ï¼ˆé»˜è®¤è¡Œä¸ºä¸å˜ï¼‰
- âœ… çµæ´»ï¼Œç”¨æˆ·å¯æƒè¡¡

**ç¼ºç‚¹**ï¼š
- âš ï¸ è¿è¡Œæ—¶é…ç½®ï¼Œç¼–è¯‘æœŸæ— æ³•æ£€æŸ¥
- âš ï¸ API å¤æ‚åº¦å¢åŠ 

### 4.3 æ–¹æ¡ˆ Cï¼šæ··åˆæ¨¡å¼ï¼ˆæ™ºèƒ½è°ƒåº¦ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šTX çº¿ç¨‹æ ¹æ®å‘½ä»¤é¢‘ç‡è‡ªåŠ¨é€‰æ‹©å‘é€ç­–ç•¥

```rust
// TX çº¿ç¨‹è‡ªåŠ¨æ£€æµ‹
if cmd_frequency > 100Hz {
    use_realtime_slot();  // é«˜é¢‘ï¼šä½¿ç”¨ realtime
} else {
    use_reliable_queue();  // ä½é¢‘ï¼šä½¿ç”¨ reliable
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨ä¼˜åŒ–

**ç¼ºç‚¹**ï¼š
- âŒ è¡Œä¸ºä¸ç¡®å®šï¼Œéš¾ä»¥è°ƒè¯•
- âŒ æ— æ³•æ»¡è¶³ç‰¹å®šéœ€æ±‚

---

## 5. æ¨èæ–¹æ¡ˆ

### 5.1 åˆ†é˜¶æ®µå®æ–½

#### ğŸ¯ **é˜¶æ®µ 1ï¼šä¿®å¤ Position æ¨¡å¼ï¼ˆç´§æ€¥ï¼‰**

**ç›®æ ‡**ï¼šè®© Position æ¨¡å¼é»˜è®¤ä½¿ç”¨ `send_reliable`

```rust
// crates/piper-client/src/raw_commander.rs
pub(crate) fn send_position_command_batch(...) -> Result<()> {
    // âœ… æ”¹ä¸ºä½¿ç”¨ reliable
    for frame in frames {
        self.driver.send_reliable(frame)?;
    }
    Ok(())
}
```

**å½±å“**ï¼š
- âœ… ä¿®å¤åºåˆ—æŒ‡ä»¤çš„å¯é æ€§é—®é¢˜
- âš ï¸ ä½ç½®æ§åˆ¶å»¶è¿Ÿå¢åŠ ï¼ˆä½†ä» < 10msï¼‰
- âš ï¸ Breaking Changeï¼ˆä½†ä¿®å¤äº† bugï¼‰

#### ğŸ¯ **é˜¶æ®µ 2ï¼šæ·»åŠ é…ç½®é€‰é¡¹ï¼ˆä¸­æœŸï¼‰**

**ç›®æ ‡**ï¼šå…è®¸ç”¨æˆ·é€‰æ‹©å‘é€ç­–ç•¥

```rust
pub enum SendStrategy {
    Auto,           // æ ¹æ®æ¨¡å¼è‡ªåŠ¨é€‰æ‹©ï¼ˆé»˜è®¤ï¼‰
    Realtime,       // å¼ºåˆ¶ä½¿ç”¨ realtime
    Reliable { timeout: Duration },  // å¼ºåˆ¶ä½¿ç”¨ reliable
}

pub struct PositionModeConfig {
    pub send_strategy: SendStrategy = SendStrategy::Auto,
    // ... å…¶ä»–å­—æ®µ
}
```

#### ğŸ¯ **é˜¶æ®µ 3ï¼šType State æ¨¡å¼ï¼ˆé•¿æœŸï¼‰**

**ç›®æ ‡**ï¼šé€šè¿‡ç±»å‹ç³»ç»Ÿå¼ºåˆ¶åŒºåˆ†å‘é€ç­–ç•¥

```rust
// ç¼–è¯‘æœŸåŒºåˆ†
impl Piper<Active<MitMode>> {
    // åªèƒ½ä½¿ç”¨ realtime
    fn command_torques(...) { ... }
}

impl Piper<Active<PositionMode>> {
    // åªèƒ½ä½¿ç”¨ reliable
    fn send_position_command(...) { ... }

    // å¯é€‰ï¼šæä¾› unsafe è½¬ä¹‰
    unsafe fn send_position_realtime(...) { ... }
}
```

### 5.2 API è®¾è®¡å»ºè®®

#### å»ºè®® 1ï¼šé«˜çº§è½¨è¿¹ API

```rust
impl Piper<Active<PositionMode>> {
    /// æ‰§è¡Œè½¨è¿¹ï¼ˆæ¨è APIï¼‰
    ///
    /// è‡ªåŠ¨å¤„ç†åºåˆ—å‘é€ã€åˆ°è¾¾æ£€æµ‹ã€é”™è¯¯æ¢å¤
    pub fn execute_trajectory(
        &self,
        trajectory: &Trajectory,
    ) -> Result<TrajectoryStatus> {
        let config = TrajectoryConfig {
            timeout: Duration::from_secs(10),
            check_arrival: true,  // ç­‰å¾…æ¯ä¸ªç‚¹åˆ°è¾¾
            ..Default::default()
        };

        self.execute_trajectory_with_config(trajectory, config)
    }
}
```

#### å»ºè®® 2ï¼šå‘é€ç­–ç•¥é…ç½®

```rust
pub struct SendOptions {
    /// å‘é€ç­–ç•¥
    pub strategy: SendStrategy = SendStrategy::Auto,

    /// å¯é æ¨¡å¼ä¸‹çš„è¶…æ—¶
    pub reliable_timeout: Duration = Duration::from_millis(10),

    /// æ˜¯å¦ç¡®è®¤åˆ°è¾¾ï¼ˆPosition æ¨¡å¼ï¼‰
    pub check_arrival: bool = true,
}

pub enum SendStrategy {
    Auto,           // æ ¹æ®æ¨¡å¼è‡ªåŠ¨é€‰æ‹©
    Realtime,       // å¼ºåˆ¶å®æ—¶æ¨¡å¼
    Reliable {      // å¼ºåˆ¶å¯é æ¨¡å¼
        timeout: Duration,
        check_arrival: bool,
    },
}
```

---

## 6. æ€§èƒ½å½±å“åˆ†æ

### 6.1 å»¶è¿Ÿå¯¹æ¯”

| åœºæ™¯ | å½“å‰æ–¹æ¡ˆ | ä¼˜åŒ–å | å½±å“ |
|------|---------|--------|------|
| MIT åŠ›æ§ï¼ˆ500Hzï¼‰ | ~1Î¼s | ~1Î¼s | âœ… æ— å½±å“ |
| ä½ç½®æ§åˆ¶ï¼ˆ100Hzï¼‰ | ~1Î¼s | ~50Î¼s | âš ï¸ å»¶è¿Ÿ +50Î¼s |
| è½¨è¿¹æ§åˆ¶ï¼ˆ10Hzï¼‰ | ~1Î¼s | ~200Î¼s | âš ï¸ å»¶è¿Ÿ +200Î¼s |

**ç»“è®º**ï¼š
- âœ… MIT æ¨¡å¼ï¼šé›¶å½±å“
- âš ï¸ Position æ¨¡å¼ï¼šå»¶è¿Ÿå¢åŠ ï¼Œä½†ä»åœ¨å¯æ¥å—èŒƒå›´ï¼ˆ< 1msï¼‰

### 6.2 å¯é æ€§å¯¹æ¯”

| åœºæ™¯ | å½“å‰æ–¹æ¡ˆ | ä¼˜åŒ–å | æ”¹å–„ |
|------|---------|--------|------|
| MIT åŠ›æ§ | 99%+ï¼ˆè‡ªçº é”™ï¼‰ | 99%+ | âœ… æ— å˜åŒ– |
| ä½ç½®æ§åˆ¶ | 80%ï¼ˆå¯èƒ½è¦†ç›–ï¼‰ | 99.9% | âœ… æ˜¾è‘—æ”¹å–„ |
| è½¨è¿¹æ§åˆ¶ | 60%ï¼ˆä¸¥é‡è¦†ç›–ï¼‰ | 99.99% | âœ… å¤§å¹…æ”¹å–„ |

---

## 7. å®æ–½å»ºè®®

### 7. ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | éš¾åº¦ | å½±å“èŒƒå›´ | æ—¶é—´ |
|--------|------|------|----------|------|
| **P0** | ä¿®å¤ Position æ¨¡å¼ä½¿ç”¨ `send_reliable` | ä½ | é«˜ | 1 å¤© |
| P1 | æ·»åŠ  `SendStrategy` é…ç½® | ä¸­ | ä¸­ | 2 å¤© |
| P2 | å®ç°é«˜çº§è½¨è¿¹ API | ä¸­ | é«˜ | 3 å¤© |
| P3 | Type State æ¨¡å¼é‡æ„ | é«˜ | é«˜ | 5 å¤© |

### 7.2 å…¼å®¹æ€§ç­–ç•¥

#### çŸ­æœŸï¼ˆv0.0.xï¼‰

- âœ… é»˜è®¤ä½¿ç”¨ `send_reliable`ï¼ˆä¿®å¤ bugï¼‰
- âœ… æ·»åŠ é…ç½®é€‰é¡¹ `SendStrategy::Realtime` å…¼å®¹æ—§è¡Œä¸º
- âœ… æ·»åŠ å¼ƒç”¨è­¦å‘Šï¼š`#[deprecated(since = "0.0.4", note = "ä½¿ç”¨ SendStrategy::Realtime")]`

#### é•¿æœŸï¼ˆv0.1.0+ï¼‰

- âœ… Type State Pattern å¼ºåˆ¶åŒºåˆ†
- âœ… ç§»é™¤å…¼å®¹é€‰é¡¹
- âœ… ç¨³å®š API

---

## 8. ç»“è®º

### 8.1 æ ¸å¿ƒå‘ç°

1. **`send_realtime` è®¾è®¡æœ¬èº«æ˜¯ä¼˜ç§€çš„**ï¼Œä¸“ä¸ºé«˜é¢‘åŠ›æ§ä¼˜åŒ–
2. **å½“å‰é—®é¢˜**ï¼šè¢«è¿‡åº¦ä½¿ç”¨ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ç”¨ realtimeï¼Œå¯¼è‡´ä½ç½®æ§åˆ¶ä¸å¯é 
3. **æ ¹æœ¬åŸå› **ï¼šç¼ºä¹å‘é€ç­–ç•¥æ§åˆ¶æœºåˆ¶

### 8.2 è®¾è®¡åŸåˆ™

**å‘é€ç­–ç•¥é€‰æ‹©åŸåˆ™**ï¼š

| æ§åˆ¶æ¨¡å¼ | é¢‘ç‡ | å¯é æ€§è¦æ±‚ | æ¨èç­–ç•¥ |
|----------|------|------------|----------|
| MIT åŠ›æ§ | 500Hz+ | ä½ï¼ˆè‡ªçº é”™ï¼‰ | âœ… Realtime |
| ä½ç½®æ§åˆ¶ | 10-100Hz | **é«˜** | âœ… Reliable |
| è½¨è¿¹æ§åˆ¶ | 1-10Hz | **æé«˜** | âœ… Reliable |
| é…ç½®å‘½ä»¤ | < 1Hz | **æé«˜** | âœ… Reliable |

**API è®¾è®¡åŸåˆ™**ï¼š

- **é»˜è®¤å®‰å…¨**ï¼šPosition æ¨¡å¼é»˜è®¤ä½¿ç”¨ `Reliable`
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šMIT æ¨¡å¼ä½¿ç”¨ `Realtime`ï¼ˆæ— é˜»å¡ï¼‰
- **æ˜¾å¼æ§åˆ¶**ï¼šæä¾› `SendStrategy` é…ç½®
- **ç±»å‹å®‰å…¨**ï¼šé•¿æœŸç›®æ ‡ï¼ŒType State Pattern

### 8.3 æœ€ç»ˆæ¨è

**ç«‹å³è¡ŒåŠ¨ï¼ˆv0.0.4ï¼‰**ï¼š

1. âœ… ä¿®å¤ Position æ¨¡å¼ä½¿ç”¨ `send_reliable`
2. âœ… MIT æ¨¡å¼ç»§ç»­ä½¿ç”¨ `send_realtime_package`
3. âœ… æ·»åŠ  `SendStrategy` é…ç½®é€‰é¡¹
4. âœ… æ·»åŠ è½¨è¿¹æ§åˆ¶é«˜çº§ API

**é•¿æœŸè§„åˆ’ï¼ˆv0.1.0ï¼‰**ï¼š

1. âœ… Type State Pattern å¼ºåˆ¶åŒºåˆ†å‘é€ç­–ç•¥
2. âœ… ç§»é™¤å…¼å®¹é€‰é¡¹
3. âœ… ç¨³å®š APIï¼Œå‘å¸ƒ v0.1.0

---

## é™„å½• Aï¼šä»£ç ç¤ºä¾‹

### A.1 å½“å‰é—®é¢˜ç¤ºä¾‹

```rust
// âŒ é—®é¢˜ï¼šä½ç½®æ§åˆ¶ä½¿ç”¨ realtime
for point in trajectory {
    robot.send_position_command(&point)?;  // ä½¿ç”¨ realtime
}

// é£é™©ï¼šå¦‚æœå‘é€é¢‘ç‡ > TX å¤„ç†é€Ÿåº¦ï¼Œåé¢çš„ç‚¹ä¼šè¦†ç›–å‰é¢çš„
// ç»“æœï¼šè½¨è¿¹å˜å½¢ï¼Œæœºå™¨äººè¿åŠ¨ä¸å¹³æ»‘
```

### A.2 ä¿®å¤åç¤ºä¾‹

```rust
// âœ… æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ reliable æ¨¡å¼
let config = PositionModeConfig {
    send_strategy: SendStrategy::Reliable {
        timeout: Duration::from_millis(10),
    },
    ..Default::default()
};
let robot = robot.enable_position_mode(config)?;

// ç°åœ¨å‘é€æ˜¯å¯é çš„
for point in trajectory {
    robot.send_position_command(&point)?;  // ä½¿ç”¨ reliable
    robot.wait_for_arrival(&point)?;      // ç­‰å¾…åˆ°ä½
}

// âœ… æ–¹æ¡ˆ 2ï¼šä½¿ç”¨é«˜çº§ API
let trajectory = Trajectory::from_points(vec![...])?;
robot.execute_trajectory(&trajectory)?;  // è‡ªåŠ¨å¤„ç†
```

### A.3 æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹

```rust
// åœºæ™¯ï¼šå‘é€ 100 ä¸ªè½¨è¿¹ç‚¹

// âŒ å½“å‰ï¼šä½¿ç”¨ realtimeï¼ˆè¦†ç›–é£é™©ï¼‰
// è¦†ç›–ç‡ï¼š~40%ï¼ˆ60% å‘½ä»¤ä¸¢å¤±ï¼‰
// å»¶è¿Ÿï¼š~1Î¼s
robot.send_position_command(&point);

// âœ… ä¿®å¤åï¼šä½¿ç”¨ reliableï¼ˆæ— ä¸¢å¤±ï¼‰
// ä¸¢å¤±ç‡ï¼š0%
// å»¶è¿Ÿï¼š~200Î¼sï¼ˆ100 ç‚¹ Ã— 2msï¼ŒåŒ…å«é˜Ÿåˆ—ç­‰å¾…ï¼‰
robot.send_position_command(&point);
```

---

## é™„å½• Bï¼šæœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| `send_realtime` | å®æ—¶å‘é€æ–¹æ³•ï¼Œä½¿ç”¨é‚®ç®±æ¨¡å¼ï¼Œå¯è¦†ç›– |
| `send_reliable` | å¯é å‘é€æ–¹æ³•ï¼Œä½¿ç”¨ FIFO é˜Ÿåˆ—ï¼ŒæŒ‰é¡ºåº |
| RealtimeCommand | å®æ—¶å‘½ä»¤ç±»å‹ï¼ˆå•ä¸ªæˆ–åŒ…ï¼‰ |
| FrameBuffer | å¸§ç¼“å†²åŒºç±»å‹ï¼ˆSmallVec<[PiperFrame; 6]>ï¼‰ |
| é‚®ç®±æ¨¡å¼ | Last Write Wins ç­–ç•¥ï¼Œæ–°å‘½ä»¤è¦†ç›–æ—§å‘½ä»¤ |
| FIFO é˜Ÿåˆ— | First In First Out ç­–ç•¥ï¼ŒæŒ‰é¡ºåºå¤„ç† |
| MIT æ¨¡å¼ | é˜»æŠ—æ§åˆ¶æ¨¡å¼ï¼Œé«˜é¢‘åŠ›æ§ |
| Position æ¨¡å¼ | ä½ç½®æ§åˆ¶æ¨¡å¼ï¼Œè½¨è¿¹è¿åŠ¨ |

---

## é™„å½• Cï¼šå‚è€ƒé“¾æ¥

- ç›¸å…³ä»£ç ï¼š
  - `crates/piper-driver/src/piper.rs` - Piper API
  - `crates/piper-driver/src/pipeline.rs` - TX çº¿ç¨‹è°ƒåº¦
  - `crates/piper-driver/src/command.rs` - å‘½ä»¤ç±»å‹å®šä¹‰
  - `crates/piper-client/src/raw_commander.rs` - å‘½ä»¤å‘é€å™¨
  - `crates/piper-client/src/state/machine.rs` - Type State çŠ¶æ€æœº

- æ–‡æ¡£ï¼š
  - `docs/v0/realtime_configuration.md` - å®æ—¶é…ç½®æŒ‡å—
  - `docs/v0/position_control_user_guide.md` - ä½ç½®æ§åˆ¶æŒ‡å—

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å®Œæˆ
**ä¸‹æ¬¡å®¡æŸ¥**ï¼šv0.0.4 å‘å¸ƒå
