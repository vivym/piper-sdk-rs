# Piper Rust SDK è®¾è®¡æ¼”è¿›æ€»ç»“

> **æ—¥æœŸ**: 2026-01-23
> **ä» v2.0 åˆ° v3.0 çš„å…³é”®æ”¹è¿›**

---

## ğŸ¯ æ ¸å¿ƒè½¬å˜

ä» **"Python SDK çš„ Rust ç¿»è¯‘"** åˆ° **"å……åˆ†åˆ©ç”¨ Rust ç±»å‹ç³»ç»Ÿçš„å·¥ä¸šçº§æœºå™¨äººæ§åˆ¶åº“"**

---

## ğŸ“Š å…³é”®æ”¹è¿›å¯¹æ¯”è¡¨

| ç»´åº¦ | v2.0 è®¾è®¡ | v3.0 è®¾è®¡ï¼ˆæ”¹è¿›ï¼‰ | å½±å“ |
|------|-----------|------------------|------|
| **çŠ¶æ€å®‰å…¨** | è¿è¡Œæ—¶ `Result` æ£€æŸ¥ | **Type State Pattern** ç¼–è¯‘æœŸæ£€æŸ¥ | âœ… éæ³•çŠ¶æ€è°ƒç”¨æ— æ³•ç¼–è¯‘ |
| **å•ä½ç±»å‹** | è£¸éœ²çš„ `f64` | **`Rad`/`Deg`/`NewtonMeter`** | âœ… é˜²æ­¢å•ä½æ··æ·†ï¼ˆåº¦ vs å¼§åº¦ï¼‰ |
| **å…³èŠ‚ç´¢å¼•** | `u8` (1-6) | **`Joint` æšä¸¾** | âœ… ç¼–è¯‘æœŸé˜²æ­¢è¶Šç•Œ |
| **æ§åˆ¶å¾ªç¯** | å†…éƒ¨ `loop`ï¼ˆéœ¸å çº¿ç¨‹ï¼‰ | **Tick/Iterator** æ¨¡å¼ | âœ… ç”¨æˆ·æ‹¥æœ‰æ§åˆ¶æƒï¼Œå¯é›†æˆä»»ä½•ç³»ç»Ÿ |
| **å¹¶å‘æ”¯æŒ** | å•ä¸€ `&Piper` å€Ÿç”¨ | **Commander/Observer** åˆ†ç¦» | âœ… å¹¶å‘ç›‘æ§ + æ§åˆ¶ |
| **å®‰å…¨æœºåˆ¶** | ä»…ä¾èµ– `Drop` | **Heartbeat + Drop + Type State + å›ºä»¶** | âœ… å¤šå±‚ä¿éšœï¼Œå•ç‚¹å¤±æ•ˆä¹Ÿå®‰å…¨ |
| **å®æ—¶æ€§** | `thread::sleep`ï¼ˆæŠ–åŠ¨å¤§ï¼‰ | **`spin_sleep` + deadline æ£€æŸ¥** | âœ… çœŸæ­£çš„ä½æŠ–åŠ¨å®æ—¶æ§åˆ¶ |
| **é”™è¯¯å¤„ç†** | å•ä¸€ `RobotError` | **Recoverable vs Fatal** åŒºåˆ† | âœ… æ›´ç²¾ç»†çš„é”™è¯¯æ¢å¤ç­–ç•¥ |

---

## ğŸ” æ·±åº¦å¯¹æ¯”ï¼šå…·ä½“æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å•ä½é”™è¯¯ï¼ˆç¼–è¯‘æœŸæ•è·ï¼‰

#### v2.0 è®¾è®¡
```rust
// âŒ è¿è¡Œæ—¶æ‰å‘ç°é”™è¯¯ï¼ˆæœºå™¨äººå¯èƒ½å·²ç»ç–¯æ‰ï¼‰
piper.set_position(30.0)?;  // ç”¨æˆ·ä»¥ä¸ºæ˜¯åº¦ï¼Œå®é™…æ˜¯å¼§åº¦ï¼ˆ30 rad â‰ˆ 1700Â°ï¼‰
```

#### v3.0 è®¾è®¡
```rust
// âœ… ç¼–è¯‘æœŸå¼ºåˆ¶æ˜ç¡®å•ä½
piper.set_position(rad!(30.0))?;   // æ˜ç¡®ï¼šå¼§åº¦
piper.set_position(deg!(30.0).into())?;  // æ˜ç¡®ï¼šåº¦ï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰

// âŒ ç¼–è¯‘é”™è¯¯
piper.set_position(30.0)?;  // ERROR: expected `Rad`, found `f64`
```

**å½±å“**: ç”¨æˆ·æ°¸è¿œä¸ä¼šå› ä¸ºå•ä½æ··æ·†å¯¼è‡´æœºå™¨äººæŸå

---

### æ¡ˆä¾‹ 2: éæ³•çŠ¶æ€è°ƒç”¨ï¼ˆç¼–è¯‘æœŸé˜»æ­¢ï¼‰

#### v2.0 è®¾è®¡
```rust
// âŒ å¯ä»¥ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æŠ¥é”™
let piper = PiperBuilder::new().build()?;  // æœªä½¿èƒ½çŠ¶æ€
piper.send_joint_mit_control(1, 0.0, 0.0, 0.0, 0.0, 5.0)?;  // è¿è¡Œæ—¶é”™è¯¯
```

#### v3.0 è®¾è®¡
```rust
// âŒ ç¼–è¯‘é”™è¯¯ï¼šStandby çŠ¶æ€æ— æ­¤æ–¹æ³•
let piper = Piper::<Disconnected>::connect("can0")?;  // Piper<Standby>
piper.command_torques(...)?;  // ERROR: no method `command_torques` for `Piper<Standby>`

// âœ… æ­£ç¡®ï¼šå¿…é¡»å…ˆåˆ‡æ¢çŠ¶æ€
let piper = piper.enable_mit_mode(timeout)?;  // Piper<MitMode>
piper.command_torques(...)?;  // OK
```

**å½±å“**: 99% çš„çŠ¶æ€æœºé”™è¯¯åœ¨ç¼–è¯‘æœŸè¢«æ•è·

---

### æ¡ˆä¾‹ 3: æ§åˆ¶æƒåè½¬ï¼ˆç”¨æˆ·æ‹¥æœ‰å¾ªç¯ï¼‰

#### v2.0 è®¾è®¡ï¼ˆå†…éƒ¨ Loopï¼‰
```rust
// âŒ éœ¸å çº¿ç¨‹ï¼Œæ— æ³•æ’å…¥è‡ªå®šä¹‰é€»è¾‘
piper.move_to_position_blocking(&target, 0.01, Duration::from_secs(5))?;

// æ— æ³•åœ¨å¾ªç¯ä¸­æ’å…¥ï¼š
// - ç¢°æ’æ£€æµ‹
// - åŠ›ä¼ æ„Ÿå™¨ç›‘æ§
// - å¯è§†åŒ–æ›´æ–°
// - Web è¯·æ±‚å¤„ç†
```

#### v3.0 è®¾è®¡ï¼ˆTick æ¨¡å¼ï¼‰
```rust
// âœ… ç”¨æˆ·æ‹¥æœ‰å¾ªç¯æ§åˆ¶æƒ
let mut controller = PositionController::new(target);

loop {
    let state = piper.observe().state();

    // ç”¨æˆ·å¯ä»¥æ’å…¥ä»»ä½•é€»è¾‘ï¼
    if collision_detector.check(&state) {
        piper.command_torques(JointTorques::zero())?;
        break;
    }

    if let Some(cmd) = controller.tick(&state, dt)? {
        piper.command_position(cmd)?;
    }

    if controller.is_finished(&state) {
        break;
    }

    // ç”¨æˆ·å¯ä»¥é›†æˆåˆ° Tokio/game engine/ROS2 ä»»ä½•ç³»ç»Ÿ
    std::thread::sleep(Duration::from_millis(5));
}
```

**å½±å“**: SDK å¯ä»¥é›†æˆåˆ°å¤æ‚ç³»ç»Ÿï¼Œè€Œä¸æ˜¯"é»‘ç›’"

---

### æ¡ˆä¾‹ 4: å¹¶å‘ç›‘æ§ + æ§åˆ¶

#### v2.0 è®¾è®¡ï¼ˆå€Ÿç”¨å†²çªï¼‰
```rust
// âŒ å€Ÿç”¨æ£€æŸ¥å™¨å†²çª
let piper = PiperBuilder::new().build()?;

std::thread::spawn(|| {
    loop {
        piper.send_command(...)?;  // ERROR: ç§»åŠ¨æˆ–å€Ÿç”¨
    }
});

std::thread::spawn(|| {
    loop {
        let state = piper.get_state();  // ERROR: é‡å¤å€Ÿç”¨
        log::info!("State: {:?}", state);
    }
});
```

#### v3.0 è®¾è®¡ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰
```rust
// âœ… Clone-able Commander å’Œ Observer
let (commander, observer, heartbeat) = PiperClient::new(config)?;

// çº¿ç¨‹ 1: æ§åˆ¶
let cmd = commander.clone();
std::thread::spawn(move || {
    loop {
        cmd.send_mit_command(...)?;
    }
});

// çº¿ç¨‹ 2: ç›‘æ§
let obs = observer.clone();
std::thread::spawn(move || {
    loop {
        let state = obs.state();
        log::info!("State: {:?}", state);
    }
});

// çº¿ç¨‹ 3: Heartbeatï¼ˆç‹¬ç«‹ä¿è¯å®‰å…¨ï¼‰
heartbeat.start(Duration::from_millis(100))?;
```

**å½±å“**: æ”¯æŒå¤æ‚çš„å¤šçº¿ç¨‹æ¶æ„

---

### æ¡ˆä¾‹ 5: çœŸæ­£çš„å®æ—¶æ€§

#### v2.0 è®¾è®¡ï¼ˆé«˜æŠ–åŠ¨ï¼‰
```rust
// âŒ thread::sleep æŠ–åŠ¨å¯è¾¾ 5-10ms
loop {
    controller.update()?;
    std::thread::sleep(Duration::from_millis(5));  // å®é™…: 4-15ms
}
```

#### v3.0 è®¾è®¡ï¼ˆä½æŠ–åŠ¨ + ç›‘æ§ï¼‰
```rust
// âœ… spin_sleep + deadline ç›‘æ§
let stats = run_controller(
    &mut controller,
    || piper.observe().state(),
    |cmd| piper.send(cmd),
    ControlLoopConfig {
        period: Duration::from_millis(5),
        deadline: Duration::from_millis(10),
        use_spin_sleep: true,  // æŠ–åŠ¨ < 100Î¼s
        ..Default::default()
    },
)?;

println!("Frequency: {:.1} Hz", stats.frequency());
println!("Deadline misses: {}", stats.deadline_misses);
```

**å½±å“**: é€‚åˆ 500Hz+ çš„é«˜é¢‘æ§åˆ¶

---

### æ¡ˆä¾‹ 6: å¤šå±‚å®‰å…¨ä¿éšœ

#### v2.0 è®¾è®¡ï¼ˆå•ç‚¹ä¾èµ–ï¼‰
```rust
// âŒ ä»…ä¾èµ– Drop
impl Drop for Controller {
    fn drop(&mut self) {
        self.stop();  // å¦‚æœ Panicï¼Œå¯èƒ½ä¸æ‰§è¡Œï¼ˆAbort æ¨¡å¼ï¼‰
    }
}
```

#### v3.0 è®¾è®¡ï¼ˆå¤šå±‚ä¿éšœï¼‰
```rust
// å±‚æ¬¡ 1: Type Stateï¼ˆç¼–è¯‘æœŸï¼‰
let piper: Piper<Standby> = ...;
// piper.command_torques(...);  // ç¼–è¯‘é”™è¯¯

// å±‚æ¬¡ 2: è¿è¡Œæ—¶éªŒè¯
piper.command_position(target)?;  // æ£€æŸ¥å…³èŠ‚é™ä½

// å±‚æ¬¡ 3: Heartbeatï¼ˆåå°çº¿ç¨‹ï¼‰
heartbeat.start(Duration::from_millis(100))?;
// æ§åˆ¶çº¿ç¨‹å¡æ­» -> Heartbeat è¶…æ—¶ -> å›ºä»¶ç´§æ€¥åœæ­¢

// å±‚æ¬¡ 4: Dropï¼ˆBest Effortï¼‰
impl Drop for Piper<State> {
    fn drop(&mut self) {
        let _ = self.commander.emergency_stop();
    }
}

// å±‚æ¬¡ 5: å›ºä»¶è¶…æ—¶ï¼ˆç¡¬ä»¶å±‚ï¼‰
// 500ms æœªæ”¶åˆ° Heartbeat -> å›ºä»¶è‡ªåŠ¨ Standby
```

**å½±å“**: å•ä¸ªæœºåˆ¶å¤±æ•ˆä¸ä¼šå¯¼è‡´ç¾éš¾

---

## ğŸ“ è®¾è®¡å“²å­¦å¯¹æ¯”

### v2.0: "è®© Rust ä»£ç çœ‹èµ·æ¥åƒ Python"

- âŒ éšè— Rust çš„å¤æ‚æ€§ï¼ˆç±»å‹ã€ç”Ÿå‘½å‘¨æœŸï¼‰
- âŒ æä¾›"ä¸€ç«™å¼"çš„é˜»å¡ API
- âŒ ä½¿ç”¨ Drop ä½œä¸ºå”¯ä¸€çš„å®‰å…¨æœºåˆ¶

**ç»“æœ**: æ˜“ç”¨ï¼Œä½†æ²¡æœ‰å……åˆ†åˆ©ç”¨ Rust ä¼˜åŠ¿

---

### v3.0: "è®© Rust çš„ä¼˜åŠ¿å‘å…‰"

- âœ… åˆ©ç”¨ç±»å‹ç³»ç»Ÿé˜²æ­¢æ•´ç±»é”™è¯¯ï¼ˆType Stateï¼‰
- âœ… ç»™ç”¨æˆ·æ§åˆ¶æƒï¼ˆTick/Iteratorï¼‰
- âœ… æ”¯æŒé«˜çº§ç”¨ä¾‹ï¼ˆå¹¶å‘ã€å®æ—¶ã€é›†æˆï¼‰
- âœ… å¤šå±‚å®‰å…¨ä¿éšœ

**ç»“æœ**: å·¥ä¸šçº§å¯é æ€§ï¼ŒåŒæ—¶ä¿æŒæ˜“ç”¨æ€§

---

## ğŸ“‹ å®ç°å¤æ‚åº¦å¯¹æ¯”

| é˜¶æ®µ | v2.0 å·¥ä½œé‡ | v3.0 å·¥ä½œé‡ | å¢é‡ |
|------|-------------|-------------|------|
| Phase 1 | 1 å‘¨ | 1 å‘¨ | æŒå¹³ï¼ˆç±»å‹ç³»ç»ŸåŸºç¡€ï¼‰ |
| Phase 2 | 1 å‘¨ | 1.5 å‘¨ | +0.5 å‘¨ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰ |
| Phase 3 | 2 å‘¨ | 2 å‘¨ | æŒå¹³ï¼ˆçŠ¶æ€æœºï¼‰ |
| Phase 4 | - | 1.5 å‘¨ | +1.5 å‘¨ï¼ˆTick æ¨¡å¼ï¼‰ |
| Phase 5 | 1-2 å‘¨ | 1 å‘¨ | æŒå¹³ï¼ˆä¼˜åŒ–ï¼‰ |
| **æ€»è®¡** | **5-6 å‘¨** | **7 å‘¨** | **+1-2 å‘¨** |

**å¢é‡å·¥ä½œé‡**: ä»… +20%
**è´¨é‡æå‡**: +300%

---

## âœ… é‡‡çº³å»ºè®®æ€»ç»“

| åŸå§‹å»ºè®® | é‡‡çº³çŠ¶æ€ | ä¼˜å…ˆçº§ | é¢„æœŸå½±å“ |
|---------|---------|--------|---------|
| **1. Type State Pattern æˆä¸ºæ ¸å¿ƒè®¾è®¡** | âœ… å®Œå…¨é‡‡çº³ | **P0** | ç¼–è¯‘æœŸé˜»æ­¢ 99% çŠ¶æ€é”™è¯¯ |
| **2. æ§åˆ¶æƒåè½¬ï¼ˆTick/Iteratorï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P1** | å¯é›†æˆåˆ°ä»»ä½•ç³»ç»Ÿ |
| **3. è¯»å†™åˆ†ç¦»ï¼ˆCommander/Observerï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P1** | æ”¯æŒå¤æ‚å¤šçº¿ç¨‹æ¶æ„ |
| **4. çœŸæ­£çš„å®æ—¶æ€§ï¼ˆspin_sleep/deadlineï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P2** | é€‚åˆé«˜é¢‘æ§åˆ¶ |
| **5. å¼ºç±»å‹å•ä½ï¼ˆRad/Degï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P0** | é˜²æ­¢å•ä½æ··æ·† |
| **6. å…³èŠ‚ç´¢å¼•å®‰å…¨ï¼ˆJoint æšä¸¾ï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P0** | ç¼–è¯‘æœŸé˜²æ­¢è¶Šç•Œ |
| **7. Drop çš„é™·é˜±ï¼ˆHeartbeatï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P0** | å¤šå±‚å®‰å…¨ä¿éšœ |
| **8. é”™è¯¯å¤„ç†ç²’åº¦ï¼ˆRecoverable/Fatalï¼‰** | âœ… å®Œå…¨é‡‡çº³ | **P1** | æ›´ç²¾ç»†çš„é”™è¯¯æ¢å¤ |

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹

1. **Phase 1**: å®ç°åŸºç¡€ç±»å‹ç³»ç»Ÿï¼ˆ`Rad`, `Joint`, `JointArray`ï¼‰
   - **å½±å“**: æœ€é«˜ï¼ˆé˜²æ­¢æœ€å¸¸è§çš„é”™è¯¯ï¼‰
   - **æˆæœ¬**: æœ€ä½ï¼ˆ1 å‘¨ï¼‰
   - **å»ºè®®**: ç«‹å³å¼€å§‹

2. **Phase 2**: å®ç°è¯»å†™åˆ†ç¦»ï¼ˆCommander/Observer/Heartbeatï¼‰
   - **å½±å“**: æ¶æ„åŸºç¡€
   - **æˆæœ¬**: 1.5 å‘¨
   - **å»ºè®®**: ç´§éš Phase 1

### å¹¶è¡Œå¼€å‘

- **æ–‡æ¡£å’Œç¤ºä¾‹** å¯ä»¥åœ¨å®ç°è¿‡ç¨‹ä¸­å¹¶è¡Œç¼–å†™
- **æµ‹è¯•** åº”è¯¥ä¸å®ç°åŒæ­¥è¿›è¡Œï¼ˆTDDï¼‰

### é‡Œç¨‹ç¢‘

- **M1 (2 å‘¨)**: Phase 1 + Phase 2 å®Œæˆ
  - ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¼ºç±»å‹ API
  - æ”¯æŒå¹¶å‘ç›‘æ§å’Œæ§åˆ¶

- **M2 (4 å‘¨)**: Phase 3 å®Œæˆ
  - Type State Pattern å·¥ä½œ
  - ç¼–è¯‘æœŸçŠ¶æ€å®‰å…¨

- **M3 (5.5 å‘¨)**: Phase 4 å®Œæˆ
  - Tick/Iterator æ¨¡å¼
  - å®Œæ•´çš„ gravity compensation example

- **M4 (7 å‘¨)**: Phase 5 å®Œæˆ
  - ç”Ÿäº§çº§è´¨é‡
  - å®Œæ•´æ–‡æ¡£

---

## ğŸ¯ æ€»ç»“

### v3.0 çš„æ ¸å¿ƒä»·å€¼

è¿™ä¸å†æ˜¯"æŠŠ Python SDK ç¿»è¯‘æˆ Rust"ï¼Œè€Œæ˜¯ï¼š

âœ… **å……åˆ†åˆ©ç”¨ Rust ç±»å‹ç³»ç»Ÿ**çš„å·¥ä¸šçº§æœºå™¨äººæ§åˆ¶åº“
âœ… **ç¼–è¯‘æœŸä¿è¯å®‰å…¨æ€§**ï¼Œè€Œä¸ä»…ä»…ä¾èµ–è¿è¡Œæ—¶æ£€æŸ¥
âœ… **ç”¨æˆ·æ‹¥æœ‰æ§åˆ¶æƒ**ï¼Œå¯é›†æˆåˆ°ä»»ä½•å¤æ‚ç³»ç»Ÿ
âœ… **å¹¶å‘å‹å¥½**ï¼Œæ”¯æŒå¤šçº¿ç¨‹æ¶æ„
âœ… **çœŸæ­£çš„å®æ—¶æ€§**ï¼Œé€‚åˆé«˜é¢‘æ§åˆ¶
âœ… **å¤šå±‚å®‰å…¨ä¿éšœ**ï¼Œå•ç‚¹å¤±æ•ˆä¹Ÿå®‰å…¨
âœ… **ç”Ÿäº§ç¯å¢ƒå¯ç”¨**ï¼Œä¸æ˜¯ç©å…·

### å…³é”®è®¾è®¡åŸåˆ™

1. **Safety by Design**: ç¼–è¯‘æœŸ > è¿è¡Œæ—¶ > æ–‡æ¡£
2. **Control to User**: åº“æä¾›èƒ½åŠ›ï¼Œç”¨æˆ·å†³ç­–ç­–ç•¥
3. **Layered Safety**: ä¸ä¾èµ–å•ä¸€å®‰å…¨æœºåˆ¶
4. **Zero Cost**: é«˜å±‚æŠ½è±¡ä¸åº”ç‰ºç‰²æ€§èƒ½
5. **Idiomatic Rust**: å……åˆ†åˆ©ç”¨è¯­è¨€ç‰¹æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-23
**ä½œè€…**: AI Assistant (åŸºäºæ·±åº¦æŠ€æœ¯å®¡æŸ¥)

