# 协议实现计划审查报告

## 发现的错误和不一致

### 1. 配置帧 ID 范围错误 ❌

**问题**：
- `protocol.md` 中配置帧范围：`0x470` ~ `0x47C`
- 但实际还有 `0x47D`（夹爪/示教器参数设置指令）和 `0x47E`（夹爪/示教器参数反馈指令）

**计划中的错误**：
```rust
// 计划中第 92 行
pub const CONFIG_END_ID: u32 = 0x47C;  // ❌ 错误，应该是 0x47E
```

**修复建议**：
```rust
pub const CONFIG_END_ID: u32 = 0x47E;  // ✅ 正确
```

**FrameType::from_id 也需要更新**：
```rust
0x470..=0x47E => FrameType::Config,  // 而不是 0x470..=0x47C
```

---

### 2. 遗漏的协议帧 ❌

#### 2.1 反馈帧遗漏

**0x481~0x486: 反馈各个关节当前末端速度/加速度**
- **协议定义**：6 个帧（0x481~0x486 代表 1~6 号关节）
- **内容**：每个关节的末端线速度、角速度、线加速度、角加速度
- **计划中**：完全没有提到
- **建议**：添加到 `feedback.rs`，优先级可以较低（Phase 3）

#### 2.2 控制帧遗漏

**0x158: 圆弧模式坐标序号更新指令**
- **协议定义**：Len: 1（只有 Byte 0）
- **内容**：指令点序号（0x00: 无效, 0x01: 起点, 0x02: 中点, 0x03: 终点）
- **计划中**：在 3.4.4 中提到"类似关节控制指令"，但没有详细设计
- **建议**：需要单独定义，因为长度只有 1 字节

#### 2.3 其他功能遗漏

**0x121: 灯光控制指令**
- **协议定义**：节点ID 0x1, 帧ID 0x121
- **内容**：控制关节上的 LED 灯光
- **计划中**：完全没有提到
- **建议**：可以放在 Phase 3 或单独的功能模块

**0x422: 固件升级模式设定指令**
- **协议定义**：数据长度 0x01
- **内容**：进入/退出固件升级模式
- **计划中**：完全没有提到
- **建议**：可以放在 Phase 3 或单独的功能模块

---

### 3. 配置帧详细设计遗漏 ❌

**0x47D: 夹爪/示教器参数设置指令**
- **协议定义**：
  - Byte 0: 示教器行程系数设置 (uint8, 100~200, 单位 %)
  - Byte 1: 夹爪/示教器最大控制行程限制值设置 (uint8, 单位 mm)
  - Byte 2: 示教器摩擦系数设置 (uint8, 1~10)
  - Byte 3-7: 保留
- **计划中**：只提到"等等..."，没有详细设计

**0x47E: 夹爪/示教器参数反馈指令**
- **协议定义**：与 0x47D 对应的反馈帧
- **计划中**：完全没有提到

**0x476: 设置指令应答**
- **协议定义**：应答各种设置指令的执行结果
- **计划中**：完全没有提到
- **建议**：这是重要的反馈帧，应该添加到 `config.rs`

**0x477: 机械臂参数查询与设置指令**
- **协议定义**：包含多个查询和设置功能
- **计划中**：只提到名称，没有详细设计

**0x478: 反馈当前末端速度/加速度参数**
- **协议定义**：反馈末端最大线速度、角速度、线加速度、角加速度
- **计划中**：完全没有提到

---

### 4. 控制模式指令 (0x151) 枚举值遗漏 ⚠️

**问题**：
- `protocol.md` 中 `ControlMode` 枚举值：
  - 0x00: 待机模式
  - 0x01: CAN指令控制模式
  - 0x02: 示教模式
  - 0x03: 以太网控制模式
  - 0x04: wifi控制模式
  - **0x05: 缺失**（协议中没有定义，但 0x151 指令中也没有）
  - **0x06: 缺失**（协议中没有定义，但 0x151 指令中也没有）
  - 0x07: 离线轨迹模式

**计划中的问题**：
- 计划中在 3.3.1 定义了完整的枚举（包括 0x05 和 0x06），但协议文档中 0x151 指令只列出了部分值
- 注意：0x2A1 反馈帧中的 ControlMode 有 0x05（遥控器控制模式）和 0x06（联动示教输入模式），但 0x151 控制指令中没有

**建议**：
- 反馈帧和控制指令的 `ControlMode` 枚举应该分开定义，或者使用 `TryFrom` 处理未定义值
- 0x151 指令中未列出的值（0x05, 0x06）应该使用 `TryFrom` 或 `#[fallback]`

---

### 5. 夹爪控制指令 (0x159) 位域设计遗漏 ⚠️

**问题**：
- `protocol.md` 中 0x159 指令：
  - Byte 6: 夹爪使能/失能/清除错误 (uint8)
    - bit0: 置1:使能 0:失能
    - bit1: 置1：清除错误
    - bit2-7: 未定义（可能是保留）
  - Byte 7: 夹爪零点设置 (uint8)
    - 0x00: 无效值（默认）
    - 0xAE: 设置当前为零点

**计划中的问题**：
- 计划中 3.4.4 只提到"类似关节控制指令"，但没有详细设计
- Byte 6 是位域，应该使用 bilge 定义

**建议**：
```rust
#[bitsize(8)]
#[derive(FromBits, DebugBits, Clone, Copy)]
pub struct GripperControlFlags {
    pub enable: bool,        // Bit 0: 使能/失能
    pub clear_error: bool,   // Bit 1: 清除错误
    pub reserved: u6,        // Bit 2-7: 保留
}
```

---

### 6. MIT 控制指令 (0x15A~0x15F) 设计不完整 ⚠️

**问题**：
- `protocol.md` 中 MIT 控制指令使用了复杂的位域打包：
  - Byte 3: Vel_ref [bit3~bit0] | Kp [bit11~bit8]
  - Byte 6: Kd [bit3~bit0] | T_ref [bit7~bit4]
  - Byte 7: T_ref [bit3~bit0] | CRC [bit3~bit0]

**计划中的问题**：
- 计划中只提到"如果协议中的位域打包复杂，可以使用 bilge 简化"，但没有具体设计
- 需要详细说明如何使用 bilge 处理这种跨字节的位域打包

**建议**：
- 需要仔细分析位域布局，可能需要使用 bilge 的嵌套结构
- 或者使用手动的位操作，因为跨字节打包比较复杂

---

### 7. 0x150 指令字段设计不完整 ⚠️

**问题**：
- `protocol.md` 中 0x150 指令：
  - Byte 4-5: NameIndex_H/L (uint16)
  - Byte 6-7: crc16_H/L (uint16)
  - 说明：Byte3~Byte7 用于离线轨迹模式下的轨迹传输

**计划中的问题**：
- 计划中只提到"Byte 4-7: 轨迹传输相关（离线轨迹模式）"，但没有详细设计字段

**建议**：
```rust
pub struct EmergencyStopCommand {
    pub emergency_stop: EmergencyStopAction,
    pub trajectory_command: TrajectoryCommand,
    pub teach_command: TeachCommand,
    pub trajectory_index: u8,
    // 离线轨迹模式字段
    pub name_index: u16,      // Byte 4-5
    pub crc16: u16,           // Byte 6-7
}
```

---

### 8. 0x470 指令设计遗漏 ⚠️

**问题**：
- `protocol.md` 中 0x470 指令：Len: 4（只有 4 字节）
- 内容：随动主从模式设置、ID 偏移值设置

**计划中的问题**：
- 计划中只提到名称，没有详细设计
- 这是重要的配置指令，需要详细设计

---

### 9. 单位转换注释错误 ⚠️

**问题**：
- `protocol.md` 中夹爪扭矩单位：**0.001N/m**
- 计划中 3.3.4：`// 单位：0.001N/m` ✅ 正确
- 但注释说"转换为 N/m"，实际上应该是 **N·m**（牛·米），不是 N/m（牛每米）

**建议**：
- 单位应该是 **N·m**（力矩单位），不是 N/m
- 需要修正注释和转换方法

---

### 10. 关节驱动器反馈字段顺序 ⚠️

**问题**：
- `protocol.md` 中 0x251~0x256（高速反馈）：
  - Byte 0-1: 转速 (int16, 单位 0.001rad/s)
  - Byte 2-3: 电流 (uint16, 单位 0.001A)
  - Byte 4-7: 位置 (int32, 单位 rad)

**计划中的问题**：
- 计划中字段顺序正确，但需要确认单位转换是否正确
- `position_rad` 的单位是 rad（不是 0.001rad），所以不需要除以 1000

---

## 总结

### 严重错误（必须修复）：
1. ❌ 配置帧 ID 范围错误（0x47C → 0x47E）
2. ❌ 遗漏多个重要的协议帧（0x481~0x486, 0x47D, 0x47E, 0x476, 0x478 等）

### 设计不完整（需要补充）：
1. ⚠️ 0x158 指令详细设计
2. ⚠️ 0x159 指令位域设计
3. ⚠️ 0x15A~0x15F MIT 控制指令详细设计
4. ⚠️ 0x150 指令完整字段设计
5. ⚠️ 0x470 指令详细设计
6. ⚠️ 0x477 指令详细设计

### 小问题（建议修复）：
1. ⚠️ 单位注释错误（N/m → N·m）
2. ⚠️ ControlMode 枚举在反馈帧和控制指令中的差异

---

## 修复优先级

### 高优先级（影响核心功能）：
1. 修复配置帧 ID 范围
2. 补充 0x158 指令设计
3. 补充 0x159 指令位域设计
4. 补充 0x150 指令完整字段

### 中优先级（影响功能完整性）：
1. 补充 0x47D, 0x47E, 0x476, 0x478 设计
2. 补充 0x470, 0x477 详细设计
3. 处理 ControlMode 枚举差异

### 低优先级（可选功能）：
1. 补充 0x481~0x486 设计
2. 补充 0x121, 0x422 设计
3. 完善 MIT 控制指令设计

