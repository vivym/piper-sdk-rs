# GS-USB å®ç°æµç¨‹å¯¹æ¯”åˆ†æ

## å¯¹æ¯”å¯¹è±¡

- **å‚è€ƒä»£ç **ï¼š`tmp/gs_usb_rs/src/device.rs`
- **å½“å‰å®ç°**ï¼š`src/can/gs_usb/`

---

## 1. å¯åŠ¨æµç¨‹å¯¹æ¯”

### å‚è€ƒä»£ç çš„ `start()` æµç¨‹

```rust
pub fn start(&mut self, flags: u32) -> Result<()> {
    // 1. Reset è®¾å¤‡ï¼ˆå¿…é¡»æˆåŠŸï¼‰
    self.handle.reset()?;

    // 2. Detach kernel driver (Linux/macOS)
    #[cfg(any(target_os = "linux", target_os = "macos"))]
    {
        if self.handle.kernel_driver_active(0).unwrap_or(false) {
            self.handle.detach_kernel_driver(0)?;
        }
    }

    // 3. Claim interfaceï¼ˆå¿…é¡»æˆåŠŸï¼‰
    self.handle.claim_interface(0)?;

    // 4. è·å–è®¾å¤‡èƒ½åŠ›
    let capability = self.device_capability()?;

    // 5. è¿‡æ»¤ flagsï¼šè®¾å¤‡æ”¯æŒçš„åŠŸèƒ½
    let mut flags = flags & capability.feature;

    // 6. è¿‡æ»¤ flagsï¼šé©±åŠ¨æ”¯æŒçš„åŠŸèƒ½ï¼ˆé‡è¦ï¼ï¼‰
    flags &= GS_CAN_MODE_LISTEN_ONLY
        | GS_CAN_MODE_LOOP_BACK
        | GS_CAN_MODE_ONE_SHOT
        | GS_CAN_MODE_HW_TIMESTAMP
        | GS_CAN_MODE_FD;

    // 7. è®¾ç½®æ¨¡å¼å¹¶å¯åŠ¨
    let mode = DeviceMode::new(GS_CAN_MODE_START, flags);
    self.control_out(GS_USB_BREQ_MODE, 0, &mode.pack())?;

    self.started = true;
    Ok(())
}
```

### æˆ‘ä»¬å½“å‰çš„ `start()` æµç¨‹

```rust
pub fn start(&mut self, flags: u32) -> Result<(), GsUsbError> {
    // 1. å¯é€‰å‡†å¤‡æ¥å£ï¼ˆå¦‚æœæœªå£°æ˜ï¼‰
    let _ = self.prepare_interface();  // å†…éƒ¨åŒ…å«ï¼šdetach, claim, reset

    // 2. Reset è®¾å¤‡ï¼ˆå¯é€‰ï¼Œå¿½ç•¥é”™è¯¯ï¼‰
    if let Err(e) = self.handle.reset() {
        trace!("Device reset failed (may be normal): {}", e);
    }

    // 3. å»¶è¿Ÿ 50ms
    std::thread::sleep(Duration::from_millis(50));

    // 4. è·å–è®¾å¤‡èƒ½åŠ›
    let capability = self.device_capability()?;

    // 5. è¿‡æ»¤ flagsï¼šè®¾å¤‡æ”¯æŒçš„åŠŸèƒ½
    let flags = flags & capability.feature;

    // 6. è®¾ç½®æ¨¡å¼å¹¶å¯åŠ¨ï¼ˆæ²¡æœ‰é©±åŠ¨çº§è¿‡æ»¤ï¼ï¼‰
    let mode = DeviceMode::new(GS_CAN_MODE_START, flags);
    self.control_out(GS_USB_BREQ_MODE, 0, &mode.pack())?;

    self.started = true;
    Ok(())
}
```

### å…³é”®å·®å¼‚

| é¡¹ç›® | å‚è€ƒä»£ç  | æˆ‘ä»¬çš„å®ç° | å½±å“ |
|------|---------|-----------|------|
| **Reset æ—¶æœº** | åœ¨ claim ä¹‹å‰ | åœ¨ claim ä¹‹åï¼ˆä¸¤æ¬¡ï¼ï¼‰ | âš ï¸ å¯èƒ½æœ‰é—®é¢˜ |
| **Reset é”™è¯¯å¤„ç†** | å¿…é¡»æˆåŠŸ (`?`) | å¿½ç•¥é”™è¯¯ | âš ï¸ å¯èƒ½éšè—é—®é¢˜ |
| **Flags é©±åŠ¨çº§è¿‡æ»¤** | âœ… æœ‰ | âŒ ç¼ºå¤± | ğŸ”´ **é‡è¦é—æ¼** |
| **å»¶è¿Ÿ** | æ—  | 100ms (prepare) + 50ms (start) = 150ms | âš ï¸ å¯èƒ½ä¸å¿…è¦ |

---

## 2. é…ç½®æµç¨‹å¯¹æ¯”

### å‚è€ƒä»£ç çš„é…ç½®æµç¨‹ï¼ˆç¤ºä¾‹ï¼‰

```rust
// 1. æ‰«æè®¾å¤‡
let devices = GsUsb::scan()?;
let mut dev = devices.into_iter().next().unwrap();

// 2. è®¾ç½®æ³¢ç‰¹ç‡ï¼ˆå…ˆï¼‰
dev.set_bitrate(250000)?;

// 3. å¯åŠ¨è®¾å¤‡ï¼ˆåï¼‰
dev.start(GS_CAN_MODE_NORMAL | GS_CAN_MODE_HW_TIMESTAMP)?;
```

**æ³¨æ„**ï¼šå‚è€ƒä»£ç **æ²¡æœ‰åœ¨ start() å‰è°ƒç”¨ `send_host_format()`**ï¼Œä½†æä¾›äº†è¯¥æ–¹æ³•ä½œä¸ºå¯é€‰é¡¹ã€‚

### æˆ‘ä»¬çš„é…ç½®æµç¨‹

```rust
// 1. æ‰«æè®¾å¤‡
let mut adapter = GsUsbCanAdapter::new()?;

// 2. é…ç½®ï¼ˆå†…éƒ¨æµç¨‹ï¼‰
adapter.configure(250_000)?;
// å†…éƒ¨è°ƒç”¨ï¼š
//   a. send_host_format()      // åè®®æ¡æ‰‹
//   b. set_bitrate(250_000)    // è®¾ç½®æ³¢ç‰¹ç‡
//   c. start(GS_CAN_MODE_NORMAL) // å¯åŠ¨è®¾å¤‡
```

---

## 3. å‘ç°çš„é—æ¼å’Œé—®é¢˜

### ğŸ”´ é—®é¢˜ 1ï¼šç¼ºå°‘ Flags é©±åŠ¨çº§è¿‡æ»¤ï¼ˆé‡è¦ï¼‰

**å‚è€ƒä»£ç **ï¼š
```rust
// åªå…è®¸é©±åŠ¨æ”¯æŒçš„åŠŸèƒ½
flags &= GS_CAN_MODE_LISTEN_ONLY
    | GS_CAN_MODE_LOOP_BACK
    | GS_CAN_MODE_ONE_SHOT
    | GS_CAN_MODE_HW_TIMESTAMP
    | GS_CAN_MODE_FD;
```

**æˆ‘ä»¬çš„ä»£ç **ï¼šç›´æ¥ä½¿ç”¨ `flags & capability.feature`ï¼Œæ²¡æœ‰é©±åŠ¨çº§è¿‡æ»¤ã€‚

**å½±å“**ï¼š
- å¦‚æœè®¾å¤‡æ”¯æŒæŸä¸ªåŠŸèƒ½ï¼Œä½†é©±åŠ¨æœªå®ç°ï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º
- ä¾‹å¦‚ï¼šå¦‚æœè®¾å¤‡æ”¯æŒ CAN FDï¼Œä½†æˆ‘ä»¬çš„é©±åŠ¨åªæ”¯æŒ CAN 2.0ï¼Œä¼ å…¥ FD flag ä¼šå‡ºé”™

**å»ºè®®**ï¼š
```rust
// åœ¨ start() ä¸­æ·»åŠ é©±åŠ¨çº§è¿‡æ»¤
let flags = flags & capability.feature
    & (GS_CAN_MODE_LISTEN_ONLY | GS_CAN_MODE_LOOP_BACK);
    // æ ¹æ®æˆ‘ä»¬å®é™…æ”¯æŒçš„åŠŸèƒ½æ·»åŠ 
```

---

### âš ï¸ é—®é¢˜ 2ï¼šReset é¡ºåºä¸ä¸€è‡´

**å‚è€ƒä»£ç **ï¼š`reset()` â†’ `detach_kernel_driver()` â†’ `claim_interface()`

**æˆ‘ä»¬çš„ä»£ç **ï¼š`prepare_interface()` (å†…éƒ¨: `detach` â†’ `claim` â†’ `reset`) â†’ `start()` (å†æ¬¡ `reset`)

**åˆ†æ**ï¼š
- å‚è€ƒä»£ç åœ¨ claim ä¹‹å‰ resetï¼ˆç¬¦åˆæŸäº›å¹³å°çš„å»ºè®®ï¼‰
- æˆ‘ä»¬çš„ä»£ç åœ¨ claim ä¹‹å resetï¼ˆé¿å…æ®µé”™è¯¯ï¼‰
- æˆ‘ä»¬åœ¨ `start()` ä¸­åˆåšäº†ä¸€æ¬¡ resetï¼ˆé‡å¤ï¼ï¼‰

**å»ºè®®**ï¼š
- å¦‚æœ `prepare_interface()` å·²ç» reset è¿‡ï¼Œ`start()` ä¸­ä¸éœ€è¦å†æ¬¡ reset
- æˆ–è€…ç»Ÿä¸€åœ¨ `start()` ä¸­ resetï¼ˆåœ¨ claim ä¹‹åï¼Œå¦‚æœä¸ä¼šå¯¼è‡´æ®µé”™è¯¯ï¼‰

---

### âš ï¸ é—®é¢˜ 3ï¼šReset é”™è¯¯å¤„ç†ç­–ç•¥

**å‚è€ƒä»£ç **ï¼š`reset()` å¿…é¡»æˆåŠŸï¼ˆ`?` ä¼ æ’­é”™è¯¯ï¼‰

**æˆ‘ä»¬çš„ä»£ç **ï¼š`reset()` å¯é€‰ï¼Œå¿½ç•¥é”™è¯¯

**åˆ†æ**ï¼š
- å‚è€ƒä»£ç è®¤ä¸º reset å¤±è´¥æ˜¯ä¸¥é‡é—®é¢˜
- æˆ‘ä»¬çš„ä»£ç è®¤ä¸º reset å¤±è´¥å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼ˆè®¾å¤‡å¯èƒ½å·²ç» reset è¿‡äº†ï¼‰

**å»ºè®®**ï¼š
- é¦–æ¬¡ resetï¼ˆåœ¨ prepare_interface ä¸­ï¼‰å¯ä»¥å¿½ç•¥é”™è¯¯
- ä½†åœ¨ `start()` ä¸­çš„ reset åº”è¯¥æ£€æŸ¥ï¼Œå› ä¸ºæ­¤æ—¶æ¥å£å·² claimï¼Œreset åº”è¯¥èƒ½æˆåŠŸ

---

### âœ… æ­£ç¡®ï¼šsend_host_format() çš„è°ƒç”¨

**å‚è€ƒä»£ç **ï¼šæ²¡æœ‰åœ¨ start() å‰è‡ªåŠ¨è°ƒç”¨ `send_host_format()`ï¼Œä½†æä¾›äº†æ–¹æ³•ã€‚

**æˆ‘ä»¬çš„ä»£ç **ï¼šåœ¨ `configure_with_mode()` ä¸­è‡ªåŠ¨è°ƒç”¨ `send_host_format()`ã€‚

**åˆ†æ**ï¼š
- æˆ‘ä»¬çš„åšæ³•æ›´ç¬¦åˆå®é™…éœ€æ±‚ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
- å‚è€ƒä»£ç å°†å…¶ä½œä¸ºå¯é€‰æ–¹æ³•ï¼Œæ›´çµæ´»ä½†éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨

**ç»“è®º**ï¼šæˆ‘ä»¬çš„åšæ³•æ˜¯æ­£ç¡®çš„ï¼Œä½†å¯ä»¥è€ƒè™‘ï¼š
- åœ¨ `start()` ä¸­è‡ªåŠ¨è°ƒç”¨ `send_host_format()`ï¼ˆè€Œä¸æ˜¯åœ¨ configure ä¸­ï¼‰
- æˆ–è€…ä¿ç•™å½“å‰åšæ³•ï¼ˆåœ¨ configure ä¸­è°ƒç”¨ï¼‰

---

### âœ… æ­£ç¡®ï¼šæ¥å£å£°æ˜æœºåˆ¶

**å‚è€ƒä»£ç **ï¼šæ¯æ¬¡ `start()` éƒ½å£°æ˜æ¥å£ï¼ˆä¸æ£€æŸ¥æ˜¯å¦å·²å£°æ˜ï¼‰

**æˆ‘ä»¬çš„ä»£ç **ï¼šä½¿ç”¨ `interface_claimed` æ ‡å¿—é¿å…é‡å¤å£°æ˜

**åˆ†æ**ï¼š
- æˆ‘ä»¬çš„åšæ³•æ›´å¥½ï¼ˆé¿å…é‡å¤ claim çš„é”™è¯¯ï¼‰
- å‚è€ƒä»£ç æ¯æ¬¡éƒ½è¦é‡æ–° claimï¼Œå¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹å¤±è´¥ï¼ˆæ¥å£å·²è¢«å ç”¨ï¼‰

**ç»“è®º**ï¼šæˆ‘ä»¬çš„å®ç°æ›´åˆç†ã€‚

---

## 4. å‚è€ƒä»£ç å¯èƒ½å­˜åœ¨çš„é—®é¢˜

### âš ï¸ é—®é¢˜ 1ï¼šæ¯æ¬¡ start() éƒ½é‡æ–° claim æ¥å£

```rust
// å‚è€ƒä»£ç çš„ start() æ¯æ¬¡éƒ½ claim
self.handle.claim_interface(0)?;
```

**é—®é¢˜**ï¼š
- å¦‚æœè®¾å¤‡å·²ç»å¯åŠ¨ï¼Œå†æ¬¡ `start()` ä¼šå°è¯• claim å·²å ç”¨çš„æ¥å£ï¼Œå¯èƒ½å¤±è´¥
- æ²¡æœ‰æ£€æŸ¥æ¥å£æ˜¯å¦å·²è¢« claim

**æˆ‘ä»¬çš„ä»£ç **ï¼šä½¿ç”¨ `interface_claimed` æ ‡å¿—é¿å…é‡å¤ claim âœ…

---

### âš ï¸ é—®é¢˜ 2ï¼šReset åœ¨ claim ä¹‹å‰ï¼ˆå¹³å°å·®å¼‚ï¼‰

```rust
// å‚è€ƒä»£ç ï¼šreset åœ¨ claim ä¹‹å‰
self.handle.reset()?;  // åœ¨ claim ä¹‹å‰
self.handle.claim_interface(0)?;
```

**é—®é¢˜**ï¼š
- åœ¨æŸäº›å¹³å°ï¼ˆå¦‚ macOSï¼‰ä¸Šï¼Œreset åœ¨ claim ä¹‹å‰å¯èƒ½å¯¼è‡´æ®µé”™è¯¯
- æˆ‘ä»¬çš„å®ç°å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼ˆåœ¨ claim ä¹‹å resetï¼‰

---

### âš ï¸ é—®é¢˜ 3ï¼šæ²¡æœ‰é‡Šæ”¾æ¥å£æœºåˆ¶

**å‚è€ƒä»£ç **ï¼š`Drop` åªè°ƒç”¨ `stop()`ï¼Œæ²¡æœ‰ `release_interface()`

**æˆ‘ä»¬çš„ä»£ç **ï¼š`Drop` ä¸­è°ƒç”¨ `release_interface()` âœ…

**å½±å“**ï¼š
- å‚è€ƒä»£ç å¯èƒ½å¯¼è‡´æ¥å£æœªè¢«é‡Šæ”¾ï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶å¯èƒ½å¤±è´¥ï¼ˆç‰¹åˆ«æ˜¯ macOS/Linuxï¼‰
- æˆ‘ä»¬çš„å®ç°æ›´å®Œæ•´

---

## 5. æ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **æ·»åŠ  Flags é©±åŠ¨çº§è¿‡æ»¤**
   ```rust
   // åœ¨ device.rs çš„ start() æ–¹æ³•ä¸­
   let flags = flags & capability.feature;

   // æ·»åŠ ï¼šåªå…è®¸æˆ‘ä»¬é©±åŠ¨æ”¯æŒçš„åŠŸèƒ½
   let flags = flags & (
       GS_CAN_MODE_LISTEN_ONLY
       | GS_CAN_MODE_LOOP_BACK
       | GS_CAN_MODE_NORMAL
       // æ ¹æ®å®é™…æ”¯æŒæ·»åŠ 
   );
   ```

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

2. **ç»Ÿä¸€ Reset é€»è¾‘**
   - å¦‚æœ `prepare_interface()` å·² resetï¼Œ`start()` ä¸­ä¸éœ€è¦å†æ¬¡ reset
   - æˆ–è€…ï¼šç§»é™¤ `prepare_interface()` ä¸­çš„ resetï¼Œåªåœ¨ `start()` ä¸­ reset

3. **æ”¹è¿› Reset é”™è¯¯å¤„ç†**
   - åœ¨ `start()` ä¸­ï¼Œå¦‚æœæ¥å£å·² claimï¼Œreset å¤±è´¥åº”è¯¥è®°å½•è­¦å‘Šä½†ä¸é˜»æ–­æµç¨‹
   - åœ¨ `prepare_interface()` ä¸­ï¼Œreset å¤±è´¥å¯ä»¥å¿½ç•¥

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

4. **ä¼˜åŒ–å»¶è¿Ÿ**
   - è¯„ä¼° `prepare_interface()` ä¸­çš„ 100ms å»¶è¿Ÿæ˜¯å¦å¿…è¦
   - è¯„ä¼° `start()` ä¸­çš„ 50ms å»¶è¿Ÿæ˜¯å¦å¿…è¦
   - å¯èƒ½å¯ä»¥åˆå¹¶æˆ–å‡å°‘

5. **send_host_format() è°ƒç”¨ä½ç½®**
   - è€ƒè™‘åœ¨ `start()` ä¸­è‡ªåŠ¨è°ƒç”¨ï¼ˆè€Œä¸æ˜¯åœ¨ configure ä¸­ï¼‰
   - è¿™æ ·å¯ä»¥ä¿è¯æ¯æ¬¡ start éƒ½ä¼šæ¡æ‰‹ï¼Œå³ä½¿è·³è¿‡äº† configure

---

## 6. æ€»ç»“

### æˆ‘ä»¬çš„å®ç°åšå¾—å¥½çš„åœ°æ–¹ âœ…

1. **æ¥å£å£°æ˜ç®¡ç†**ï¼šä½¿ç”¨ `interface_claimed` æ ‡å¿—é¿å…é‡å¤ claim
2. **Drop æ¸…ç†**ï¼šæ­£ç¡®é‡Šæ”¾æ¥å£ï¼Œé¿å…èµ„æºæ³„æ¼
3. **Reset é¡ºåº**ï¼šåœ¨ claim ä¹‹å resetï¼Œé¿å…æ®µé”™è¯¯ï¼ˆç‰¹åˆ«æ˜¯ macOSï¼‰
4. **send_host_format**ï¼šè‡ªåŠ¨è°ƒç”¨ï¼Œæé«˜å…¼å®¹æ€§
5. **é”™è¯¯æ¢å¤**ï¼šè¶…æ—¶åæ¸…é™¤ endpoint halt çŠ¶æ€

### éœ€è¦æ”¹è¿›çš„åœ°æ–¹ âš ï¸

1. **Flags é©±åŠ¨çº§è¿‡æ»¤**ï¼šç¼ºå°‘å¯¹é©±åŠ¨æ”¯æŒåŠŸèƒ½çš„æ£€æŸ¥ ğŸ”´
2. **Reset é€»è¾‘é‡å¤**ï¼šåœ¨ `prepare_interface()` å’Œ `start()` ä¸­éƒ½ reset
3. **å»¶è¿Ÿä¼˜åŒ–**ï¼šæ€»å»¶è¿Ÿ 150ms å¯èƒ½å¯ä»¥ä¼˜åŒ–

### å‚è€ƒä»£ç çš„é—®é¢˜ âš ï¸

1. **æ¥å£å£°æ˜**ï¼šæ¯æ¬¡ start éƒ½é‡æ–° claimï¼Œå¯èƒ½å¤±è´¥
2. **Reset é¡ºåº**ï¼šåœ¨ claim ä¹‹å‰ resetï¼Œå¯èƒ½å¯¼è‡´æ®µé”™è¯¯
3. **èµ„æºæ¸…ç†**ï¼šç¼ºå°‘ `release_interface()` è°ƒç”¨

---

## 7. æ¨èçš„æ”¹è¿›æ­¥éª¤

1. âœ… **ç«‹å³æ·»åŠ  Flags é©±åŠ¨çº§è¿‡æ»¤**ï¼ˆé‡è¦ï¼‰
2. âœ… **ç»Ÿä¸€ Reset é€»è¾‘**ï¼ˆç§»é™¤é‡å¤ï¼‰
3. âš ï¸ **è¯„ä¼°å»¶è¿Ÿçš„å¿…è¦æ€§**ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
