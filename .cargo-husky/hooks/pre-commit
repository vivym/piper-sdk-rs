#!/bin/sh

# æ£€æŸ¥æš‚å­˜åŒºä¸­æ˜¯å¦æœ‰ Rust æºæ–‡ä»¶
RS_FILES=$(git diff --cached --name-only | grep -E '\.rs$' || true)

if [ -z "$RS_FILES" ]; then
  echo "â„¹ï¸  No Rust files changed, skipping pre-commit checks."
  exit 0
fi

echo "ğŸ¦€ Rust files changed in this commit:"
echo "$RS_FILES"
echo ""

# 1. ç¡®ä¿ä»£ç æ ¼å¼åŒ–æ­£ç¡® (å¦‚æœæ ¼å¼ä¸å¯¹ï¼Œè¿™é‡Œä¼šæŠ¥é”™)
echo "Running cargo fmt..."
cargo fmt --all -- --check
if [ $? -ne 0 ]; then
  echo "âŒ Cargo fmt failed."
  echo "ğŸ’¡ Run 'cargo fmt --all' to fix formatting."
  exit 1
fi

# 2. è¿è¡Œ Clippy (å…³é”®ï¼šåŠ ä¸Š -D warnings ä½¿å¾—è­¦å‘Šå˜æˆé”™è¯¯ï¼Œé˜»æ­¢æäº¤)
# ä½¿ç”¨ --all-targets --all-features ä¸ CI ä¿æŒä¸€è‡´
echo "Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings
if [ $? -ne 0 ]; then
  echo "âŒ Cargo clippy failed."
  exit 1
fi

# 3. è¿è¡Œæµ‹è¯• (ä»…å½“æœ‰ Rust æ–‡ä»¶å˜æ›´æ—¶)
echo "Running cargo test..."
cargo test
if [ $? -ne 0 ]; then
  echo "âŒ Cargo test failed."
  exit 1
fi

echo "âœ… Pre-commit checks passed!"
